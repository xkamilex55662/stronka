<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Czat Globalny - Rejestracja na nick + hasÅ‚o</title>
<style>
  body {
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
  }
  #chatBox {
    width: 400px;
    height: 300px;
    border: 1px solid #444;
    margin: 20px auto;
    background: rgba(0,0,0,0.6);
    padding: 10px;
    overflow-y: auto;
    text-align: left;
    border-radius: 8px;
  }
  #msgInput {
    width: 320px;
    padding: 5px;
    margin-top: 5px;
    background: #333;
    color: white;
    border: 1px solid #444;
    border-radius: 4px;
  }
  #sendBtn {
    padding: 6px 12px;
    background: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }
  #sendBtn:hover {
    background: #218838;
  }
  #authContainer {
    margin-top: 20px;
  }
  input[type="text"], input[type="password"] {
    padding: 8px;
    font-size: 14px;
    margin: 5px;
    border-radius: 4px;
    border: none;
    width: 150px;
  }
  button {
    cursor: pointer;
  }
  #errorMsg {
    color: #f44336;
    font-weight: bold;
    margin-top: 10px;
  }
  .message {
    display: flex;
    justify-content: space-between;
    margin: 4px 0;
  }
  .msg-text {
    flex: 1;
  }
  .msg-time {
    color: #aaa;
    font-size: 12px;
    margin-left: 10px;
    white-space: nowrap;
  }
  .deleteBtn {
    background: #d9534f;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
    padding: 2px 6px;
    font-size: 12px;
  }
  #userInfo {
    margin-top: 10px;
  }
</style>
</head>
<body>

<h2>ðŸ’¬ Czat Globalny</h2>
<h4>Online: <span id="userCount">0</span></h4>

<div id="chatBox"></div>

<div id="sendContainer" style="display:none;">
  <input type="text" id="msgInput" placeholder="Napisz wiadomoÅ›Ä‡..." />
  <button id="sendBtn">WyÅ›lij</button>
</div>

<div id="authContainer">
  <h3>Rejestracja</h3>
  <input type="text" id="regNick" placeholder="Nick" />
  <input type="password" id="regPass" placeholder="HasÅ‚o" />
  <button id="registerBtn">Zarejestruj siÄ™</button>

  <h3>Logowanie</h3>
  <input type="text" id="loginNick" placeholder="Nick" />
  <input type="password" id="loginPass" placeholder="HasÅ‚o" />
  <button id="loginBtn">Zaloguj siÄ™</button>

  <div id="errorMsg"></div>
</div>

<div id="userInfo" style="display:none;">
  Zalogowano jako: <span id="currentUserNick"></span>
  <button id="logoutBtn">Wyloguj siÄ™</button>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, set, get, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

// Konfiguracja Firebase - zastÄ…p swoimi danymi
const firebaseConfig = {
  apiKey: "AIzaSyBWtZUr7xoa31uoH18hksqSjCXMd2F18Ew",
  authDomain: "strona-f0d19.firebaseapp.com",
  databaseURL: "https://strona-f0d19-default-rtdb.firebaseio.com",
  projectId: "strona-f0d19",
  storageBucket: "strona-f0d19.firebasestorage.app",
  messagingSenderId: "34203329400",
  appId: "1:34203329400:web:c934bf311237b1a6701e8d",
  measurementId: "G-HYCP5F1J3E"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const regNick = document.getElementById('regNick');
const regPass = document.getElementById('regPass');
const registerBtn = document.getElementById('registerBtn');

const loginNick = document.getElementById('loginNick');
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');

const errorMsg = document.getElementById('errorMsg');

const chatBox = document.getElementById('chatBox');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const sendContainer = document.getElementById('sendContainer');

const authContainer = document.getElementById('authContainer');
const userInfo = document.getElementById('userInfo');
const currentUserNickSpan = document.getElementById('currentUserNick');
const logoutBtn = document.getElementById('logoutBtn');

const userCountSpan = document.getElementById('userCount');

let currentUser = null; // Obiekt: {nick, isAdmin}
let onlineUsers = {};

function hashPassword(pass) {
  // Prosty hash - dla demo! W produkcji uÅ¼yj lepszego (np. bcrypt server-side)
  let hash = 0, i, chr;
  for (i = 0; i < pass.length; i++) {
    chr = pass.charCodeAt(i);
    hash = ((hash << 5) - hash) + chr;
    hash |= 0;
  }
  return hash.toString();
}

// Rejestracja
registerBtn.addEventListener('click', async () => {
  const nick = regNick.value.trim();
  const pass = regPass.value.trim();
  errorMsg.textContent = '';

  if (!nick || !pass) {
    errorMsg.textContent = 'WypeÅ‚nij nick i hasÅ‚o!';
    return;
  }
  if (nick.length < 3) {
    errorMsg.textContent = 'Nick musi mieÄ‡ minimum 3 znaki!';
    return;
  }

  // SprawdÅº czy nick jest wolny
  const userRef = ref(db, 'users/' + nick);
  const snapshot = await get(userRef);
  if (snapshot.exists()) {
    errorMsg.textContent = 'Ten nick jest juÅ¼ zajÄ™ty!';
    return;
  }

  // Zapisz uÅ¼ytkownika
  await set(userRef, {
    passwordHash: hashPassword(pass),
    isAdmin: false
  });

  errorMsg.style.color = 'lime';
  errorMsg.textContent = 'Zarejestrowano! Teraz siÄ™ zaloguj.';
  regNick.value = '';
  regPass.value = '';
});

// Logowanie
loginBtn.addEventListener('click', async () => {
  const nick = loginNick.value.trim();
  const pass = loginPass.value.trim();
  errorMsg.style.color = 'red';
  errorMsg.textContent = '';

  if (!nick || !pass) {
    errorMsg.textContent = 'WypeÅ‚nij nick i hasÅ‚o!';
    return;
  }

  const userRef = ref(db, 'users/' + nick);
  const snapshot = await get(userRef);
  if (!snapshot.exists()) {
    errorMsg.textContent = 'Nie ma takiego uÅ¼ytkownika!';
    return;
  }
  const data = snapshot.val();
  if (data.passwordHash !== hashPassword(pass)) {
    errorMsg.textContent = 'Niepoprawne hasÅ‚o!';
    return;
  }

  // Zalogowano
  currentUser = {
    nick: nick,
    isAdmin: data.isAdmin || false
  };
  errorMsg.textContent = '';
  authContainer.style.display = 'none';
  userInfo.style.display = 'block';
  currentUserNickSpan.textContent = nick;
  sendContainer.style.display = 'block';

  // Dodaj do online
  const onlineRef = ref(db, 'online/' + nick);
  set(onlineRef, true);

  // UsuÅ„ przy wylogowaniu lub zamkniÄ™ciu
  window.addEventListener('beforeunload', () => {
    remove(onlineRef);
  });

  loadMessages();
  loadOnlineUsers();
});

// Wyloguj siÄ™
logoutBtn.addEventListener('click', () => {
  if (!currentUser) return;
  const onlineRef = ref(db, 'online/' + currentUser.nick);
  remove(onlineRef);
  currentUser = null;
  authContainer.style.display = 'block';
  userInfo.style.display = 'none';
  sendContainer.style.display = 'none';
  chatBox.innerHTML = '';
  userCountSpan.textContent = '0';
  errorMsg.textContent = '';
});

// WysyÅ‚anie wiadomoÅ›ci
sendBtn.addEventListener('click', () => {
  if (!currentUser) return;
  const text = msgInput.value.trim();
  if (!text) return;

  const messagesRef = ref(db, 'messages');
  push(messagesRef, {
    user: currentUser.nick,
    text: text,
    timestamp: Date.now()
  });
  msgInput.value = '';
});

// Åadowanie wiadomoÅ›ci i wyÅ›wietlanie z moÅ¼liwoÅ›ciÄ… usuwania dla admina
function loadMessages() {
  const messagesRef = ref(db, 'messages');
  onValue(messagesRef, (snapshot) => {
    chatBox.innerHTML = '';
    snapshot.forEach((msgSnap) => {
      const msg = msgSnap.val();
      const key = msgSnap.key;
      const time = formatDate(msg.timestamp);
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';

      const textDiv = document.createElement('div');
      textDiv.className = 'msg-text';
      textDiv.innerHTML = `<b>${escapeHtml(msg.user)}:</b> ${escapeHtml(msg.text)}`;
      messageDiv.appendChild(textDiv);

      const timeDiv = document.createElement('div');
      timeDiv.className = 'msg-time';
      timeDiv.textContent = time;
      messageDiv.appendChild(timeDiv);

      if(currentUser && currentUser.isAdmin) {
        const delBtn = document.createElement('button');
        delBtn.className = 'deleteBtn';
        delBtn.textContent = 'UsuÅ„';
        delBtn.addEventListener('click', () => {
          if(confirm('Na pewno usunÄ…Ä‡ tÄ™ wiadomoÅ›Ä‡?')) {
            remove(ref(db, 'messages/' + key));
          }
        });
        messageDiv.appendChild(delBtn);
      }

      chatBox.appendChild(messageDiv);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

// Åadowanie liczby online
function loadOnlineUsers() {
  const onlineRef = ref(db, 'online');
  onValue(onlineRef, (snapshot) => {
    userCountSpan.textContent = snapshot.size;
  });
}

// Formatowanie daty i godziny
function formatDate(timestamp) {
  if (!timestamp) return '';
  const d = new Date(timestamp);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  const time = d.toLocaleTimeString('pl-PL', {hour: '2-digit', minute: '2-digit'});
  return `${day}.${month}.${year} ${time}`;
}

// Proste zabezpieczenie przed XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

</script>
</body>
</html>
