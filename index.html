<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Discord - Friends & Groups</title>
<style>
:root{
    --bg: #1e1e2d;
    --panel: #27293d;
    --muted: #a0a0b0;
    --accent: #6b7cff;
    --glass: rgba(255, 255, 255, 0.05);
}
*{box-sizing:border-box;}
body{margin:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:var(--bg);color:white;height:100vh;display:flex;overflow:hidden;}
.sidebar, .middle, .main {padding:12px;display:flex;flex-direction:column;gap:12px;}
.sidebar{width:220px;background:var(--panel);}
.middle{width:260px;background:#232537;}
.main{flex:1;background:var(--bg);}
input, button{
    font-family: inherit;
    border-radius: 8px;
    border: none;
    background: var(--glass);
    color: white;
    padding: 10px;
    transition: background 0.2s;
}
input::placeholder {color: var(--muted);}
input:focus {outline: none; background: rgba(255,255,255,0.1);}
button{cursor:pointer;background:var(--accent);color:white;font-weight:600;}
button:hover {filter:brightness(1.1);}
.profile{display:flex;align-items:center;gap:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,0.1);position:relative;}
.avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, #4fc3f7, #7e57c2);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;overflow:hidden;flex-shrink:0;}
.avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.nick{font-weight:700;}
.status-dropdown{position:relative;margin-top:4px;cursor:pointer;}
.status-selected{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--muted);}
.status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
.status-options{position:absolute;top:100%;left:0;width:150px;background:var(--panel);border-radius:8px;overflow:hidden;display:none;flex-direction:column;box-shadow:0 5px 15px rgba(0,0,0,0.3);z-index:100;}
.status-options div{padding:8px;display:flex;align-items:center;gap:5px;cursor:pointer;}
.status-options div:hover{background:rgba(255,255,255,0.1);}
.logoutBtn, .settingsBtn{background:none;border:none;color:var(--muted);font-size:18px;position:absolute;top:50%;transform:translateY(-50%);cursor:pointer;padding:0;}
.logoutBtn{right:0;}
.settingsBtn{right:40px;}
.friends-list, .groups-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;}
.friend-item, .group-item{display:flex;align-items:center;padding:8px;border-radius:8px;background:var(--glass);cursor:pointer;transition:background 0.2s;}
.friend-item:hover, .group-item:hover{background:rgba(255,255,255,0.1);}
.friend-item .avatar, .group-item .avatar{width:32px;height:32px;font-size:12px;margin-right:10px;}
.friend-item .name, .group-item .name{font-weight:600;}
.friend-item .small-muted, .group-item .small-muted{font-size:11px;color:var(--muted);}
.friend-item .right-actions{margin-left:auto;display:flex;gap:6px;}
.friend-item .right-actions button{padding:6px 12px;background:var(--accent);font-size:12px;}
.friend-item .right-actions button.accept{background:#4CAF50;}
.friend-item .right-actions button.dm-btn{background:none;border:1px solid var(--accent);color:var(--accent);}
.friend-item .right-actions button.dm-btn:hover{background:var(--accent);color:white;}
.chat-header{padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:15px;position:relative;}
.chat-header .avatar{width:50px;height:50px;font-size:18px;}
.chat-title{font-weight:700;font-size:20px;}
.chat-sub{font-size:14px;color:var(--muted);}
.messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;}
.msg-container{display:flex;align-items:flex-start;gap:10px;}
.msg-container.me{flex-direction:row-reverse;}
.msg-container .avatar{width:32px;height:32px;flex-shrink:0;}
.msg{
    max-width:70%;
    padding:10px 15px;
    border-radius:18px;
    background:rgba(255,255,255,0.08);
    word-wrap:break-word;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.msg.me{
    background:linear-gradient(90deg,var(--accent),#8b7dff);
    color:white;
    border-top-right-radius: 4px;
}
.msg:not(.me){
    border-top-left-radius: 4px;
}
.msg .meta{font-size:11px;color:var(--muted);margin-bottom:4px;display:flex;justify-content:space-between;font-weight:600;}
.msg.me .meta{color:rgba(255,255,255,0.8);}
.composer{display:flex;width:100%;gap:10px;align-items:center;}
.composer input[type=text]{flex:1;}
.auth-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:999;}
.auth-card{background:#232537;padding:30px;border-radius:16px;width:380px;display:flex;flex-direction:column;gap:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
.auth-card h3{text-align: center; margin: 0 0 10px 0;}
.auth-card .toggle-btn{background: none; color: var(--accent); font-weight: 500; font-size: 14px; text-align: center; cursor: pointer;}
.auth-card .toggle-btn:hover{text-decoration: underline;}
.auth-card .auth-form{display: flex; flex-direction: column; gap: 12px;}
.auth-card .form-group{display: flex; flex-direction: column; gap: 5px;}
.auth-card .form-group label{font-size: 14px; color: var(--muted);}
h3{margin-top:0;}
label{color:var(--muted);font-size:14px;}
.group-creator {display: flex; flex-direction: column; gap: 10px; padding: 10px; border: 1px solid var(--muted); border-radius: 8px;}
.group-creator .checkbox-list {max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px;}
.delete-btn {background: #f44336; margin-left: auto; padding: 6px 12px; font-size: 12px;}
.chat-header .delete-group-btn {position: absolute; right: 12px; top: 12px; background: #f44336;}
</style>
</head>
<body>
<div class="sidebar">
    <div class="profile">
        <div class="avatar" id="meAvatar">--</div>
        <div>
            <div class="nick" id="meNick">Zaloguj si</div>
            <div class="status-dropdown" id="statusDropdown">
                <div class="status-selected" id="statusSelected">
                    <span class="status-dot" style="background:gray"></span> Offline
                </div>
                <div class="status-options" id="statusOptions">
                    <div data-status="Online"><span class="status-dot" style="background:green"></span> Online</div>
                    <div data-status="Zaraz wracam"><span class="status-dot" style="background:yellow"></span> Zaraz wracam</div>
                    <div data-status="Nie przeszkadza"><span class="status-dot" style="background:red"></span> Nie przeszkadza</div>
                    <div data-status="Offline"><span class="status-dot" style="background:gray"></span> Offline</div>
                </div>
            </div>
        </div>
        <button class="logoutBtn" id="logoutBtn" style="display:none"></button>
    </div>
    <h4 style="color:var(--muted); margin:0;">Znajomi</h4>
    <input id="addFriendInput" placeholder="Dodaj znajomego..." />
    <button id="addFriendBtn">Dodaj</button>
    <div class="friends-list" id="friendsList"></div>
    ---
    <h4 style="color:var(--muted); margin:0;">Grupy</h4>
    <button id="createGroupBtn">Stw贸rz grup</button>
    <div class="groups-list" id="groupsList"></div>
    ---
    <div class="group-creator" id="groupCreator" style="display:none;">
        <label>Nazwa grupy:</label>
        <input id="groupNameInput" placeholder="Nazwa grupy" />
        <label>Uczestnicy:</label>
        <div class="checkbox-list" id="groupFriendsList"></div>
        <button id="confirmCreateGroupBtn">Stw贸rz</button>
        <button id="cancelCreateGroupBtn">Anuluj</button>
    </div>
</div>
<div class="middle">
    <h4 style="color:var(--muted); margin:0;">Zaproszenia</h4>
    <div class="friends-list" id="requestsList"></div>
</div>
<div class="main">
    <div class="chat-header">
        <div class="avatar" id="chatAvatar">?</div>
        <div>
            <div class="chat-title" id="chatTitle">Wybierz znajomego</div>
            <div class="chat-sub" id="chatSub">Prywatna rozmowa</div>
        </div>
        <button id="deleteGroupBtn" class="delete-group-btn" style="display:none;">Usu grup</button>
    </div>
    <div class="messages" id="messages"></div>
    <div class="composer">
        <input type="text" id="msgInput" placeholder="Napisz wiadomo..." autocomplete="off" />
        <button id="sendMsgBtn">Wylij</button>
    </div>
</div>
<div class="auth-modal" id="authModal">
    <div class="auth-card">
        <div id="loginForm">
            <h3>Logowanie</h3>
            <div class="auth-form">
                <div class="form-group">
                    <label for="logNick">Nick</label>
                    <input id="logNick" placeholder="Tw贸j nick">
                </div>
                <div class="form-group">
                    <label for="logPass">Haso</label>
                    <input id="logPass" type="password" placeholder="Twoje haso">
                </div>
                <button id="btnLogin">Zaloguj si</button>
            </div>
            <button class="toggle-btn" id="showRegBtn">Nie masz konta? Zarejestruj si</button>
        </div>
        <div id="registerForm" style="display:none;">
            <h3>Rejestracja</h3>
            <div class="auth-form">
                <div class="form-group">
                    <label for="regNick">Nick</label>
                    <input id="regNick" placeholder="Wybierz nick">
                </div>
                <div class="form-group">
                    <label for="regPass">Haso</label>
                    <input id="regPass" type="password" placeholder="Wybierz haso">
                </div>
                <button id="btnRegister">Zarejestruj si</button>
            </div>
            <button class="toggle-btn" id="showLogBtn">Masz ju偶 konto? Zaloguj si</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, push, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
    apiKey: "AIzaSyBWtZUr7xoa31uoH18hksqSjCXMd2F18Ew",
    authDomain: "strona-f0d19.firebaseapp.com",
    databaseURL: "https://strona-f0d19-default-rtdb.firebaseio.com",
    projectId: "strona-f0d19",
    storageBucket: "strona-f0d19.firebasestorage.app",
    messagingSenderId: "34203329400",
    appId: "1:34203329400:web:c934bf311a6701e8d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== DOM =====
const authModal = document.getElementById('authModal');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const showRegBtn = document.getElementById('showRegBtn');
const showLogBtn = document.getElementById('showLogBtn');
const btnRegister = document.getElementById('btnRegister');
const btnLogin = document.getElementById('btnLogin');
const regNick = document.getElementById('regNick');
const regPass = document.getElementById('regPass');
const logNick = document.getElementById('logNick');
const logPass = document.getElementById('logPass');
const meNickEl = document.getElementById('meNick');
const meAvatar = document.getElementById('meAvatar');
const statusDropdown = document.getElementById('statusDropdown');
const statusSelected = document.getElementById('statusSelected');
const statusOptions = document.getElementById('statusOptions');
const logoutBtn = document.getElementById('logoutBtn');
const friendsListEl = document.getElementById('friendsList');
const addFriendInput = document.getElementById('addFriendInput');
const addFriendBtn = document.getElementById('addFriendBtn');
const requestsListEl = document.getElementById('requestsList');
const chatTitle = document.getElementById('chatTitle');
const chatSub = document.getElementById('chatSub');
const chatAvatar = document.getElementById('chatAvatar');
const messagesEl = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendMsgBtn = document.getElementById('sendMsgBtn');
const createGroupBtn = document.getElementById('createGroupBtn');
const groupCreator = document.getElementById('groupCreator');
const groupNameInput = document.getElementById('groupNameInput');
const groupFriendsList = document.getElementById('groupFriendsList');
const confirmCreateGroupBtn = document.getElementById('confirmCreateGroupBtn');
const cancelCreateGroupBtn = document.getElementById('cancelCreateGroupBtn');
const groupsListEl = document.getElementById('groupsList');
const deleteGroupBtn = document.getElementById('deleteGroupBtn');

let currentUser = null;
let currentChatId = null;
let currentChatType = null;
let myStatus = 'Offline';

// ===== AUTH =====
showRegBtn.onclick = () => {loginForm.style.display='none'; registerForm.style.display='block';};
showLogBtn.onclick = () => {registerForm.style.display='none'; loginForm.style.display='block';};
btnRegister.onclick = async ()=>{
    const nick = regNick.value.trim();
    const pass = regPass.value;
    if(!nick||!pass){alert('Nick i haso s wymagane.');return;}
    const snap = await get(ref(db,'users/'+nick));
    if(snap.exists()){alert('Nick jest ju偶 zajty.');return;}
    await set(ref(db,'users/'+nick),{password:pass,createdAt:Date.now()});
    loginAs(nick);
};
btnLogin.onclick = async ()=>{
    const nick = logNick.value.trim();
    const pass = logPass.value;
    const snap = await get(ref(db,'users/'+nick));
    if(!snap.exists() || snap.val().password!==pass){alert('Bdny nick lub haso.'); return;}
    loginAs(nick);
};

function loginAs(nick){
    currentUser = nick;
    localStorage.setItem('currentUser', nick);
    authModal.style.display='none';
    meNickEl.textContent = nick;
    meAvatar.innerHTML = `<div>${nick.slice(0,2).toUpperCase()}</div>`;
    logoutBtn.style.display='inline-block';
    initPresence();
    startListeners();
    const statusRef = ref(db,'status/'+currentUser);
    onValue(statusRef,snap=>{
        myStatus = snap.val() || 'Offline';
        updateStatusUI(myStatus);
    });
}

logoutBtn.onclick = ()=>{
    remove(ref(db,'online/'+currentUser));
    localStorage.removeItem('currentUser');
    location.reload();
};

// ===== PRESENCE =====
function initPresence(){
    const onRef = ref(db,'online/'+currentUser);
    set(onRef,true);
    onDisconnect(onRef).remove();
}

// ===== STATUS =====
statusSelected.onclick = ()=>{statusOptions.style.display = statusOptions.style.display==='flex'?'none':'flex';};
statusOptions.querySelectorAll('div').forEach(div=>{
    div.onclick= async ()=>{
        const st = div.dataset.status;
        myStatus=st;
        await set(ref(db,'status/'+currentUser),st);
        updateStatusUI(st);
        statusOptions.style.display='none';
    };
});
function updateStatusUI(st){
    const color = st==='Online'?'green':st==='Zaraz wracam'?'yellow':st==='Nie przeszkadza'?'red':'gray';
    statusSelected.innerHTML=`<span class="status-dot" style="background:${color}"></span> ${st}`;
}

// ===== FRIENDS & GROUPS =====
addFriendBtn.onclick = async ()=>{
    const nick = addFriendInput.value.trim();
    if(!nick||nick===currentUser){alert('Nieprawidowy nick.');return;}
    const s = await get(ref(db,'users/'+nick));
    if(!s.exists()){alert('U偶ytkownik nie istnieje.'); return;}
    const f = await get(ref(db,`friends/${currentUser}/${nick}`));
    if(f.exists()){alert('Ju偶 jestecie znajomymi.');return;}
    await set(ref(db,`friendRequests/${nick}/${currentUser}`),{from:currentUser,at:Date.now()});
    alert('Wysano zaproszenie.');
    addFriendInput.value='';
};

createGroupBtn.onclick = async () => {
    const snap = await get(ref(db, `friends/${currentUser}`));
    groupFriendsList.innerHTML = '';
    groupNameInput.value = '';
    if (snap.exists()) {
        snap.forEach(friendSnap => {
            const friendNick = friendSnap.key;
            const item = document.createElement('label');
            item.innerHTML = `<input type="checkbox" value="${friendNick}" /> ${friendNick}`;
            groupFriendsList.appendChild(item);
        });
        groupCreator.style.display = 'flex';
    } else {
        alert("Musisz mie znajomych, aby stworzy grup.");
    }
};

cancelCreateGroupBtn.onclick = () => {
    groupCreator.style.display = 'none';
};

confirmCreateGroupBtn.onclick = async () => {
    const groupName = groupNameInput.value.trim();
    const members = [currentUser];
    document.querySelectorAll('#groupFriendsList input:checked').forEach(checkbox => {
        members.push(checkbox.value);
    });

    if (groupName.length < 3) {
        alert('Nazwa grupy musi mie co najmniej 3 znaki.');
        return;
    }
    if (members.length < 2) {
        alert('Grupa musi mie co najmniej dw贸ch uczestnik贸w.');
        return;
    }
    
    const groupKey = push(ref(db, 'groups')).key;
    const groupData = {
        name: groupName,
        members: members,
        owner: currentUser,
        createdAt: Date.now()
    };
    await set(ref(db, `groups/${groupKey}`), groupData);

    for (const member of members) {
        await set(ref(db, `userGroups/${member}/${groupKey}`), true);
    }

    alert('Grupa zostaa stworzona!');
    groupCreator.style.display = 'none';
};

// Nowa funkcja do usuwania znajomych
async function deleteFriend(friendNick) {
    if (confirm(`Czy na pewno chcesz usun ${friendNick} ze znajomych?`)) {
        await remove(ref(db, `friends/${currentUser}/${friendNick}`));
        await remove(ref(db, `friends/${friendNick}/${currentUser}`));
        alert(`${friendNick} zosta usunity z listy znajomych.`);
    }
}

// Nowa funkcja do usuwania grupy
async function deleteGroup(groupId) {
    if (confirm("Czy na pewno chcesz usun t grup?")) {
        const groupDataSnap = await get(ref(db, `groups/${groupId}`));
        if (groupDataSnap.exists()) {
            const groupData = groupDataSnap.val();
            // Sprawdzamy czy u偶ytkownik jest wacicielem
            if (groupData.owner !== currentUser) {
                alert("Nie jeste wacicielem tej grupy i nie mo偶esz jej usun.");
                return;
            }
            // Usuwamy grup z list czonk贸w
            for (const member of groupData.members) {
                await remove(ref(db, `userGroups/${member}/${groupId}`));
            }
            // Usuwamy sam grup
            await remove(ref(db, `groups/${groupId}`));
            // Usuwamy wiadomoci grupy
            await remove(ref(db, `groupMessages/${groupId}`));
            alert("Grupa zostaa usunita.");
            // Resetujemy widok
            chatTitle.textContent = "Wybierz znajomego";
            chatSub.textContent = "Prywatna rozmowa";
            chatAvatar.innerHTML = "?";
            messagesEl.innerHTML = "";
            deleteGroupBtn.style.display = 'none';
        }
    }
}

deleteGroupBtn.onclick = () => {
    if (currentChatType === 'group' && currentChatId) {
        deleteGroup(currentChatId);
    }
};

function startListeners(){
    onValue(ref(db,`friends/${currentUser}`),()=>loadFriends());
    onValue(ref(db,`friendRequests/${currentUser}`),()=>loadRequests());
    onValue(ref(db,`userGroups/${currentUser}`),()=>loadGroups());
}

async function loadFriends(){
    const snap = await get(ref(db,`friends/${currentUser}`));
    friendsListEl.innerHTML='';
    if(snap.exists()){
        snap.forEach(s=>{
            const nick = s.key;
            const item=document.createElement('div');item.className='friend-item';
            const avatarHtml = `<div>${nick.slice(0,2).toUpperCase()}</div>`;
            const left=document.createElement('div');left.className='friend-left';
            const av=document.createElement('div');av.className='avatar';av.innerHTML=avatarHtml;
            const info=document.createElement('div');info.innerHTML=`<div class="name">${nick}</div><div class="small-muted" id="st_${nick}">?</div>`;
            left.appendChild(av);left.appendChild(info);
            const right=document.createElement('div');right.className='right-actions';
            const dmBtn=document.createElement('button');dmBtn.textContent='DM';dmBtn.className='dm-btn';
            dmBtn.onclick=()=>openChat(nick, 'dm');
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Usu';
            delBtn.className = 'delete-btn';
            delBtn.onclick = () => deleteFriend(nick);
            right.appendChild(dmBtn);
            right.appendChild(delBtn);
            item.appendChild(left);item.appendChild(right);
            friendsListEl.appendChild(item);

            const onRef = ref(db,'status/'+nick);
            onValue(onRef,snap=>{
                const stEl=document.getElementById('st_'+nick);
                if(stEl) stEl.textContent = snap.exists()?snap.val():'Offline';
            });
        });
    }
}

async function loadGroups(){
    const snap = await get(ref(db,`userGroups/${currentUser}`));
    groupsListEl.innerHTML = '';
    if(snap.exists()){
        const promises = [];
        snap.forEach(groupSnap => {
            const groupId = groupSnap.key;
            promises.push(get(ref(db, `groups/${groupId}`)));
        });
        const groupDataSnaps = await Promise.all(promises);
        groupDataSnaps.forEach(groupDataSnap => {
            if (groupDataSnap.exists()) {
                const groupId = groupDataSnap.key;
                const groupData = groupDataSnap.val();
                const item = document.createElement('div');
                item.className = 'group-item';
                item.innerHTML = `
                    <div class="avatar">#</div>
                    <div>
                        <div class="name">${groupData.name}</div>
                        <div class="small-muted">${groupData.members.length} czonk贸w</div>
                    </div>
                `;
                item.onclick = () => openChat(groupId, 'group');
                groupsListEl.appendChild(item);
            }
        });
    }
}

async function loadRequests(){
    const snap = await get(ref(db,`friendRequests/${currentUser}`));
    requestsListEl.innerHTML='';
    if(snap.exists()){
        snap.forEach(r=>{
            const el=document.createElement('div');el.className='friend-item';
            el.innerHTML=`<div><span class="name">${r.key}</span></div>`;
            const right=document.createElement('div');right.className='right-actions';
            const acc=document.createElement('button');acc.textContent='Akceptuj';acc.className='accept';
            acc.onclick=async ()=>{
                await set(ref(db,`friends/${currentUser}/${r.key}`),true);
                await set(ref(db,`friends/${r.key}/${currentUser}`),true);
                await remove(ref(db,`friendRequests/${currentUser}/${r.key}`));
            };
            right.appendChild(acc);el.appendChild(right);
            requestsListEl.appendChild(el);
        });
    }
}

// ===== CHAT =====
async function openChat(id, type){
    currentChatId = id;
    currentChatType = type;
    deleteGroupBtn.style.display = 'none';

    if(type === 'dm'){
        chatTitle.textContent = id;
        chatSub.textContent = 'Prywatna rozmowa';
        const avatarHtml = `<div>${id.slice(0,2).toUpperCase()}</div>`;
        chatAvatar.innerHTML = avatarHtml;
    } else {
        const groupRef = ref(db, `groups/${id}`);
        const groupDataSnap = await get(groupRef);
        if (groupDataSnap.exists()) {
            const groupData = groupDataSnap.val();
            chatTitle.textContent = groupData.name;
            chatSub.textContent = `${groupData.members.length} czonk贸w: ${groupData.members.join(', ')}`;
            chatAvatar.innerHTML = `<div>#</div>`;
            if (groupData.owner === currentUser) {
                deleteGroupBtn.style.display = 'block';
            }
        }
    }
    loadMessages();
}

function loadMessages(){
    if(!currentChatId) return;
    const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
    const chatRef = ref(db, messagesPath);
    onValue(chatRef,snap=>{
        messagesEl.innerHTML='';
        snap.forEach(s=>{
            const msg=s.val();
            const isMe = msg.from===currentUser;
            const avatarHtml = `<div>${msg.from.slice(0,2).toUpperCase()}</div>`;
            const container=document.createElement('div');container.className=`msg-container ${isMe?'me':''}`;
            const av=document.createElement('div');av.className='avatar';av.innerHTML=avatarHtml;
            const div=document.createElement('div');div.className='msg'+(isMe?' me':'');
            let content = `<div class="meta"><span>${msg.from}</span> <span style="margin-left:5px;font-weight: normal; color: var(--muted);">${new Date(msg.timestamp).toLocaleTimeString()}</span></div>${msg.text || ''}`;
            div.innerHTML = content;
            container.appendChild(av);container.appendChild(div);
            messagesEl.appendChild(container);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
    });
}

sendMsgBtn.onclick = async ()=>{
    if(!currentChatId) return;
    const text = msgInput.value.trim();
    if(!text){alert("Wpisz wiadomo.");return;}
    const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
    const chatRef = ref(db, messagesPath);
    let msgObj = {from:currentUser,timestamp:Date.now(), text: text};
    await push(chatRef,msgObj);
    msgInput.value='';
}

// INIT
const storedUser = localStorage.getItem('currentUser');
if(storedUser) loginAs(storedUser);
</script>
</body>
</html>
