
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Discord - Friends & Groups</title>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="profile">
                <div class="avatar" id="meAvatar">--</div>
                <div>
                    <div class="nick" id="meNick">Zaloguj się</div>
                    <div class="status-dropdown" id="statusDropdown">
                        <div class="status-selected" id="statusSelected">
                            <span class="status-dot" style="background:gray"></span> Offline
                        </div>
                        <div class="status-options" id="statusOptions">
                            <div data-status="Online"><span class="status-dot" style="background:green"></span> Online</div>
                            <div data-status="Zaraz wracam"><span class="status-dot" style="background:yellow"></span> Zaraz wracam</div>
                            <div data-status="Nie przeszkadzać"><span class="status-dot" style="background:red"></span> Nie przeszkadzać</div>
                            <div data-status="Offline"><span class="status-dot" style="background:gray"></span> Offline</div>
                        </div>
                    </div>
                </div>
                <button class="logoutBtn" id="logoutBtn" style="display:none">🚪</button>
            </div>

            <div class="requests-toggle" id="requestsToggle">
                <h4 style="color:var(--muted); margin:0;">Zaproszenia</h4>
                <span class="requests-count" id="requestsCount">0</span>
            </div>
            <div class="requests-list" id="requestsList"></div>

            <hr class="section-divider">

            <h4 style="color:var(--muted); margin:0;">Znajomi</h4>
            <input id="addFriendInput" placeholder="Dodaj znajomego..." />
            <button id="addFriendBtn">Dodaj</button>
            <div class="friends-list" id="friendsList"></div>

            <hr class="section-divider">

            <h4 style="color:var(--muted); margin:0;">Grupy</h4>
            <button id="createGroupBtn">Stwórz grupę</button>
            <div class="groups-list" id="groupsList"></div>

            <div class="group-creator" id="groupCreator" style="display:none;">
                <label>Nazwa grupy:</label>
                <input id="groupNameInput" placeholder="Nazwa grupy" />
                <label>Uczestnicy:</label>
                <div class="checkbox-list" id="groupFriendsList"></div>
                <button id="confirmCreateGroupBtn">Stwórz</button>
                <button id="cancelCreateGroupBtn">Anuluj</button>
            </div>
        </div>

        <div class="main">
            <!-- DODAŁEM PRZYCISKI MOBILNE (☰ i 👥) - będą widoczne tylko na telefonie -->
            <div class="chat-header">
                <button id="toggleSidebar" class="mobile-btn" aria-label="menu">☰</button>

                <div class="avatar" id="chatAvatar">?</div>
                <div>
                    <div class="chat-title" id="chatTitle">Wybierz znajomego</div>
                    <div class="chat-sub" id="chatSub">Prywatna rozmowa</div>
                </div>

                <!-- przycisk otwierający panel członków na mobile -->
                <button id="toggleMembers" class="mobile-btn" aria-label="members">👥</button>

                <button id="deleteGroupBtn" class="delete-group-btn" style="display:none;">Usuń grupę</button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="composer">
                <input type="text" id="msgInput" placeholder="Napisz wiadomość... lub wklej link do obrazka/GIF-a" autocomplete="off" />
                <button id="sendMsgBtn">Wyślij</button>
            </div>
        </div>
        
        <div class="members-panel" id="membersPanel">
            <h4 id="membersPanelTitle">Członkowie</h4>
            <div id="membersList" class="member-list"></div>
        </div>
        
    </div>

    <!-- backdrop używany na mobile gdy wysunięty sidebar/members -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <div class="profile-modal" id="profileModal">
        <div class="avatar profile-modal-avatar" id="profileAvatar">?</div>
        <h3 id="profileNick"></h3>
        <div id="profileStatus"></div>
        <div id="profileJoinDate" class="small-muted"></div>
    </div>

    <div class="auth-modal" id="authModal">
        <div class="auth-card">
            <div id="loginForm">
                <h3>Logowanie</h3>
                <div class="auth-form">
                    <div class="form-group">
                        <label for="logNick">Nick</label>
                        <input id="logNick" placeholder="Twój nick">
                    </div>
                    <div class="form-group">
                        <label for="logPass">Hasło</label>
                        <input id="logPass" type="password" placeholder="Twoje hasło">
                    </div>
                    <button id="btnLogin">Zaloguj się</button>
                </div>
                <button class="toggle-btn" id="showRegBtn">Nie masz konta? Zarejestruj się</button>
            </div>
            <div id="registerForm" style="display:none;">
                <h3>Rejestracja</h3>
                <div class="auth-form">
                    <div class="form-group">
                        <label for="regNick">Nick</label>
                        <input id="regNick" placeholder="Wybierz nick (max 6 znaków)">
                    </div>
                    <div class="form-group">
                        <label for="regPass">Hasło</label>
                        <input id="regPass" type="password" placeholder="Wybierz hasło">
                    </div>
                    <button id="btnRegister">Zarejestruj się</button>
                </div>
                <button class="toggle-btn" id="showLogBtn">Masz już konto? Zaloguj się</button>
            </div>
        </div>
    </div>

    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item delete" id="deleteMsgItem">Usuń dla wszystkich</div>
    </div>

    <!-- ====== TWÓJ ORYGINALNY SKRYPT (bez usuwania) ====== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyBWtZUr7xoa31uoH18hksqSjCXMd2F18Ew",
            authDomain: "strona-f0d19.firebaseapp.com",
            databaseURL: "https://strona-f0d19-default-rtdb.firebaseio.com",
            projectId: "strona-f0d19",
            storageBucket: "strona-f0d19.firebasestorage.app",
            messagingSenderId: "34203329400",
            appId: "1:34203329400:web:c934bf311a6701e8d"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ===== DOM =====
        const authModal = document.getElementById('authModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegBtn = document.getElementById('showRegBtn');
        const showLogBtn = document.getElementById('showLogBtn');
        const btnRegister = document.getElementById('btnRegister');
        const btnLogin = document.getElementById('btnLogin');
        const regNick = document.getElementById('regNick');
        const regPass = document.getElementById('regPass');
        const logNick = document.getElementById('logNick');
        const logPass = document.getElementById('logPass');
        const meNickEl = document.getElementById('meNick');
        const meAvatar = document.getElementById('meAvatar');
        const statusDropdown = document.getElementById('statusDropdown');
        const statusSelected = document.getElementById('statusSelected');
        const statusOptions = document.getElementById('statusOptions');
        const logoutBtn = document.getElementById('logoutBtn');
        const friendsListEl = document.getElementById('friendsList');
        const addFriendInput = document.getElementById('addFriendInput');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const requestsListEl = document.getElementById('requestsList');
        const requestsToggle = document.getElementById('requestsToggle');
        const requestsCountEl = document.getElementById('requestsCount');
        const chatTitle = document.getElementById('chatTitle');
        const chatSub = document.getElementById('chatSub');
        const chatAvatar = document.getElementById('chatAvatar');
        const messagesEl = document.getElementById('messages');
        const msgInput = document.getElementById('msgInput');
        const sendMsgBtn = document.getElementById('sendMsgBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const groupCreator = document.getElementById('groupCreator');
        const groupNameInput = document.getElementById('groupNameInput');
        const groupFriendsList = document.getElementById('groupFriendsList');
        const confirmCreateGroupBtn = document.getElementById('confirmCreateGroupBtn');
        const cancelCreateGroupBtn = document.getElementById('cancelCreateGroupBtn');
        const groupsListEl = document.getElementById('groupsList');
        const deleteGroupBtn = document.getElementById('deleteGroupBtn');
        const activeUsersCountEl = document.getElementById('activeUsersCount');
        const contextMenu = document.getElementById('contextMenu');
        const deleteMsgItem = document.getElementById('deleteMsgItem');
        const membersPanel = document.getElementById('membersPanel');
        const membersList = document.getElementById('membersList');
        const profileModal = document.getElementById('profileModal');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileNick = document.getElementById('profileNick');
        const profileStatus = document.getElementById('profileStatus');
        const profileJoinDate = document.getElementById('profileJoinDate');

        let currentUser = null;
        let currentChatId = null;
        let currentChatType = null;
        let myStatus = 'Online';
        let activeMessageId = null;
        let unsubscribeMessageListener = null;
        let unsubscribeGroupMembersListener = null;

        // ===== AUTH =====
        showRegBtn.onclick = () => { loginForm.style.display = 'none'; registerForm.style.display = 'block'; };
        showLogBtn.onclick = () => { registerForm.style.display = 'none'; loginForm.style.display = 'block'; };

        btnRegister.onclick = async () => {
            const nick = regNick.value.trim();
            const pass = regPass.value;
            if (!nick || !pass) { alert('Nick i hasło są wymagane.'); return; }
            if (nick.length > 6) {
                alert('Nick może mieć maksymalnie 6 znaków.');
                return;
            }
            const snap = await get(ref(db, 'users/' + nick));
            if (snap.exists()) { alert('Nick jest już zajęty.'); return; }
            await set(ref(db, 'users/' + nick), { password: pass, createdAt: Date.now() });
            loginAs(nick);
        };

        btnLogin.onclick = async () => {
            const nick = logNick.value.trim();
            const pass = logPass.value;
            const snap = await get(ref(db, 'users/' + nick));
            if (!snap.exists() || snap.val().password !== pass) { alert('Błędny nick lub hasło.'); return; }
            loginAs(nick);
        };

        function loginAs(nick) {
            currentUser = nick;
            localStorage.setItem('currentUser', nick);
            authModal.style.display = 'none';
            meNickEl.textContent = nick;
            meAvatar.innerHTML = `<div>${nick.slice(0, 2).toUpperCase()}</div>`;
            logoutBtn.style.display = 'inline-block';
            initPresence();
            startListeners();
            set(ref(db, 'status/' + currentUser), 'Online');
            
            const statusRef = ref(db, 'status/' + currentUser);
            onValue(statusRef, snap => {
                myStatus = snap.val() || 'Offline';
                updateStatusUI(meNickEl.textContent, myStatus);
            });

            meAvatar.onclick = () => showProfile(currentUser);
            meNickEl.onclick = () => showProfile(currentUser);
        }
        
        meNickEl.addEventListener('dblclick', () => {
            const currentNick = meNickEl.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'nick-input';
            input.value = currentNick;
            meNickEl.replaceWith(input);
            input.focus();

            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    const newNick = input.value.trim();
                    if (newNick === currentNick || newNick.length > 6 || newNick.length === 0) {
                        alert('Nieprawidłowy nick. Może mieć maks. 6 znaków i nie może być pusty.');
                        input.replaceWith(meNickEl);
                        meNickEl.textContent = currentNick;
                        return;
                    }

                    const snap = await get(ref(db, 'users/' + newNick));
                    if (snap.exists()) {
                        alert('Nick jest już zajęty.');
                        input.replaceWith(meNickEl);
                        meNickEl.textContent = currentNick;
                        return;
                    }

                    const userRef = ref(db, 'users/' + currentNick);
                    const userData = (await get(userRef)).val();
                    await set(ref(db, 'users/' + newNick), userData);
                    
                    const statusRef = ref(db, 'status/' + currentNick);
                    const statusData = (await get(statusRef)).val();
                    await set(ref(db, 'status/' + newNick), statusData);

                    currentUser = newNick;
                    localStorage.setItem('currentUser', newNick);
                    meNickEl.textContent = newNick;
                    meAvatar.innerHTML = `<div>${newNick.slice(0, 2).toUpperCase()}</div>`;
                    
                    await remove(userRef);
                    await remove(statusRef);
                    
                    input.replaceWith(meNickEl);
                }
            });
        });

        logoutBtn.onclick = () => {
            set(ref(db, 'status/' + currentUser), 'Offline');
            remove(ref(db, 'online/' + currentUser));
            localStorage.removeItem('currentUser');
            location.reload();
        };

        // ===== PRESENCE =====
        function initPresence() {
            if (!currentUser) return;
            const onRef = ref(db, 'online/' + currentUser);
            set(onRef, true);
            onValue(ref(db, 'online'), (snapshot) => {
                const count = snapshot.size;
                activeUsersCountEl.textContent = count;
            });
        }

        // ===== STATUS =====
        statusSelected.onclick = () => { statusOptions.style.display = statusOptions.style.display === 'flex' ? 'none' : 'flex'; };
        statusOptions.querySelectorAll('div').forEach(div => {
            div.onclick = async () => {
                const st = div.dataset.status;
                myStatus = st;
                await set(ref(db, 'status/' + currentUser), st);
                updateStatusUI(meNickEl.textContent, st);
                statusOptions.style.display = 'none';
            };
        });
        function updateStatusUI(userNick, st) {
            const dot = document.getElementById('st_' + userNick) || statusSelected.querySelector('.status-dot');
            const color = st === 'Online' ? 'green' : st === 'Zaraz wracam' ? 'yellow' : st === 'Nie przeszkadzać' ? 'red' : 'gray';
            if (dot) dot.style.background = color;
            if (document.getElementById('st_' + userNick)) {
                 document.getElementById('st_' + userNick).textContent = st;
            }
            if(userNick === currentUser) {
                 statusSelected.innerHTML = `<span class="status-dot" style="background:${color}"></span> ${st}`;
            }
        }

        // ===== FRIENDS & GROUPS =====
        addFriendBtn.onclick = async () => {
            const nick = addFriendInput.value.trim();
            if (!nick || nick === currentUser) { alert('Nieprawidłowy nick.'); return; }
            const s = await get(ref(db, 'users/' + nick));
            if (!s.exists()) { alert('Użytkownik nie istnieje.'); return; }
            const f = await get(ref(db, `friends/${currentUser}/${nick}`));
            if (f.exists()) { alert('Już jesteście znajomymi.'); return; }
            await set(ref(db, `friendRequests/${nick}/${currentUser}`), { from: currentUser, at: Date.now() });
            alert('Wysłano zaproszenie.');
            addFriendInput.value = '';
        };

        createGroupBtn.onclick = async () => {
            const snap = await get(ref(db, `friends/${currentUser}`));
            groupFriendsList.innerHTML = '';
            groupNameInput.value = '';
            if (snap.exists()) {
                snap.forEach(friendSnap => {
                    const friendNick = friendSnap.key;
                    const item = document.createElement('label');
                    item.innerHTML = `<input type="checkbox" value="${friendNick}" /> ${friendNick}`;
                    groupFriendsList.appendChild(item);
                });
                groupCreator.style.display = 'flex';
            } else {
                alert("Musisz mieć znajomych, aby stworzyć grupę.");
            }
        };

        cancelCreateGroupBtn.onclick = () => {
            groupCreator.style.display = 'none';
        };

        confirmCreateGroupBtn.onclick = async () => {
            const groupName = groupNameInput.value.trim();
            const members = [currentUser];
            document.querySelectorAll('#groupFriendsList input:checked').forEach(checkbox => {
                members.push(checkbox.value);
            });

            if (groupName.length < 3) {
                alert('Nazwa grupy musi mieć co najmniej 3 znaki.');
                return;
            }
            if (members.length < 2) {
                alert('Grupa musi mieć co najmniej dwóch uczestników.');
                return;
            }

            const groupKey = push(ref(db, 'groups')).key;
            const groupData = {
                name: groupName,
                members: members,
                owner: currentUser,
                createdAt: Date.now()
            };
            await set(ref(db, `groups/${groupKey}`), groupData);

            for (const member of members) {
                await set(ref(db, `userGroups/${member}/${groupKey}`), true);
            }

            alert('Grupa została stworzona!');
            groupCreator.style.display = 'none';
        };

        async function deleteFriend(friendNick) {
            if (confirm(`Czy na pewno chcesz usunąć ${friendNick} ze znajomych?`)) {
                await remove(ref(db, `friends/${currentUser}/${friendNick}`));
                await remove(ref(db, `friends/${friendNick}/${currentUser}`));
                alert(`${friendNick} został usunięty z listy znajomych.`);
            }
        }

        async function deleteGroup(groupId) {
            if (confirm("Czy na pewno chcesz usunąć tę grupę?")) {
                const groupDataSnap = await get(ref(db, `groups/${groupId}`));
                if (groupDataSnap.exists()) {
                    const groupData = groupDataSnap.val();
                    if (groupData.owner !== currentUser) {
                        alert("Nie jesteś właścicielem tej grupy i nie możesz jej usunąć.");
                        return;
                    }
                    for (const member of groupData.members) {
                        await remove(ref(db, `userGroups/${member}/${groupId}`));
                    }
                    await remove(ref(db, `groups/${groupId}`));
                    await remove(ref(db, `groupMessages/${groupId}`));
                    alert("Grupa została usunięta.");
                    chatTitle.textContent = "Wybierz znajomego";
                    chatSub.textContent = "Prywatna rozmowa";
                    chatAvatar.innerHTML = "?";
                    messagesEl.innerHTML = "";
                    deleteGroupBtn.style.display = 'none';
                    membersPanel.style.display = 'none';
                    profileModal.style.display = 'none';
                    currentChatId = null;
                }
            }
        }

        deleteGroupBtn.onclick = () => {
            if (currentChatType === 'group' && currentChatId) {
                deleteGroup(currentChatId);
            }
        };

        function startListeners() {
            onValue(ref(db, `friends/${currentUser}`), () => loadFriends());
            onValue(ref(db, `friendRequests/${currentUser}`), () => loadRequests());
            onValue(ref(db, `userGroups/${currentUser}`), () => loadGroups());
            
            onValue(ref(db, 'groups'), (snapshot) => {
                if (snapshot.exists()) {
                    const groupsData = snapshot.val();
                    for (const groupId in groupsData) {
                        const group = groupsData[groupId];
                        const groupItem = document.querySelector(`.group-item[data-id="${groupId}"] .name`);
                        if (groupItem && groupItem.textContent !== group.name) {
                            groupItem.textContent = group.name;
                        }
                    }
                }
            });

            onValue(ref(db, 'status'), (snapshot) => {
                if (snapshot.exists()) {
                    const statuses = snapshot.val();
                    updateMemberStatuses(statuses);
                }
            });
        }

        function updateMemberStatuses(statuses) {
            const memberItems = membersList.querySelectorAll('.member-item');
            memberItems.forEach(item => {
                const nick = item.querySelector('.name').textContent;
                const statusInfo = statuses[nick] || 'Offline';
                const dot = item.querySelector('.avatar-status-dot');
                const statusTextEl = item.querySelector('.member-status-text');

                let color = 'gray';
                let statusText = statusInfo;
                let badge = '';

                switch (statusInfo) {
                    case 'Online':
                        color = 'green';
                        break;
                    case 'Zaraz wracam':
                        color = 'yellow';
                        break;
                    case 'Nie przeszkadzać':
                        color = 'red';
                        break;
                    case 'W grze':
                         color = '#5c6bc0';
                         badge = `👾 W grze <span class="status-badge">Gra</span>`;
                         break;
                    case 'Rozmawia':
                         color = '#2196F3';
                         badge = `🎤 Rozmawia <span class="status-badge">Rozmowa</span>`;
                         break;
                    default:
                        color = 'gray';
                }

                if (dot) dot.style.backgroundColor = color;
                if (statusTextEl) {
                    statusTextEl.innerHTML = badge || statusText;
                }
            });
        }

        async function loadFriends() {
            const snap = await get(ref(db, `friends/${currentUser}`));
            friendsListEl.innerHTML = '';
            if (snap.exists()) {
                snap.forEach(s => {
                    const nick = s.key;
                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    const avatarHtml = `<div>${nick.slice(0, 2).toUpperCase()}</div>`;
                    item.innerHTML = `
                        <div class="avatar">${avatarHtml}</div>
                        <div>
                            <div class="name">${nick}</div>
                            <div class="small-muted" id="st_${nick}">?</div>
                        </div>
                        <div class="right-actions">
                            <button class="dm-btn">DM</button>
                            <button class="delete-btn">Usuń</button>
                        </div>
                    `;
                    item.querySelector('.dm-btn').onclick = () => openChat(nick, 'dm');
                    item.querySelector('.delete-btn').onclick = () => deleteFriend(nick);
                    item.onclick = (e) => {
                        if (!e.target.closest('.right-actions')) {
                            showProfile(nick);
                        }
                    };
                    friendsListEl.appendChild(item);

                    const onRef = ref(db, 'status/' + nick);
                    onValue(onRef, snap => {
                        const stEl = document.getElementById('st_' + nick);
                        if (stEl) stEl.textContent = snap.exists() ? snap.val() : 'Offline';
                    });
                });
            }
        }

        async function loadGroups() {
            const snap = await get(ref(db, `userGroups/${currentUser}`));
            groupsListEl.innerHTML = '';
            if (snap.exists()) {
                const groupIds = Object.keys(snap.val());
                const promises = groupIds.map(groupId => get(ref(db, `groups/${groupId}`)));
                const groupDataSnaps = await Promise.all(promises);

                groupDataSnaps.forEach(groupDataSnap => {
                    if (groupDataSnap.exists()) {
                        const groupId = groupDataSnap.key;
                        const groupData = groupDataSnap.val();
                        const item = document.createElement('div');
                        item.className = 'group-item';
                        item.setAttribute('data-id', groupId);
                        item.innerHTML = `
                            <div class="avatar">#</div>
                            <div>
                                <div class="name">${groupData.name}</div>
                                <div class="small-muted">${groupData.members.length} członków</div>
                            </div>
                        `;
                        item.onclick = () => openChat(groupId, 'group');
                        groupsListEl.appendChild(item);
                    }
                });
            }
        }

        requestsToggle.onclick = () => {
            requestsListEl.style.display = requestsListEl.style.display === 'flex' ? 'none' : 'flex';
        };

        // ===== AUTO OFFLINE ON EXIT =====
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                set(ref(db, 'status/' + currentUser), 'Offline');
                remove(ref(db, 'online/' + currentUser));
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                if (document.visibilityState === 'hidden') {
                    set(ref(db, 'status/' + currentUser), 'Offline');
                    remove(ref(db, 'online/' + currentUser));
                } else {
                    set(ref(db, 'status/' + currentUser), 'Online');
                    set(ref(db, 'online/' + currentUser), true);
                }
            }
        });

        async function loadRequests() {
            const snap = await get(ref(db, `friendRequests/${currentUser}`));
            requestsListEl.innerHTML = '';
            const requests = snap.exists() ? snap.val() : {};
            const count = Object.keys(requests).length;
            requestsCountEl.textContent = count;

            if (count > 0) {
                Object.keys(requests).forEach(senderNick => {
                    const el = document.createElement('div');
                    el.className = 'request-item';
                    el.innerHTML = `<span class="name">${senderNick}</span>`;
                    const right = document.createElement('div');
                    right.className = 'right-actions';
                    const acc = document.createElement('button'); acc.textContent = 'Akceptuj'; acc.className = 'accept';
                    acc.onclick = async () => {
                        await set(ref(db, `friends/${currentUser}/${senderNick}`), true);
                        await set(ref(db, `friends/${senderNick}/${currentUser}`), true);
                        await remove(ref(db, `friendRequests/${currentUser}/${senderNick}`));
                    };
                    const rej = document.createElement('button'); rej.textContent = 'Odrzuć'; rej.className = 'delete-btn';
                    rej.onclick = async () => {
                        await remove(ref(db, `friendRequests/${currentUser}/${senderNick}`));
                    };
                    right.appendChild(acc);
                    right.appendChild(rej);
                    el.appendChild(right);
                    requestsListEl.appendChild(el);
                });
            } else {
                requestsListEl.innerHTML = '<div style="color: var(--muted); text-align:center;">Brak nowych zaproszeń.</div>';
            }
        }

        // ===== PROFILE MODAL =====
        async function showProfile(userNick) {
            const userRef = ref(db, `users/${userNick}`);
            const statusRef = ref(db, `status/${userNick}`);
            
            const userSnap = await get(userRef);
            const statusSnap = await get(statusRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.val();
                const status = statusSnap.val() || 'Offline';
                
                profileAvatar.innerHTML = `<div>${userNick.slice(0, 2).toUpperCase()}</div>`;
                profileNick.textContent = userNick;
                profileStatus.textContent = status;
                
                const joinDate = new Date(userData.createdAt).toLocaleDateString();
                profileJoinDate.textContent = `Dołączył: ${joinDate}`;
            }
            profileModal.style.display = 'flex';
        }

        document.addEventListener('click', (e) => {
            if (profileModal.style.display === 'flex' && !profileModal.contains(e.target) && !e.target.closest('.friend-item') && !e.target.closest('.member-item') && !e.target.closest('.profile')) {
                profileModal.style.display = 'none';
            }
        });

        // ===== CHAT =====
        async function openChat(id, type) {
            if (unsubscribeMessageListener) {
                unsubscribeMessageListener();
            }
            if (unsubscribeGroupMembersListener) {
                unsubscribeGroupMembersListener();
            }

            currentChatId = id;
            currentChatType = type;
            deleteGroupBtn.style.display = 'none';
            profileModal.style.display = 'none';
            membersPanel.style.display = 'none';
            contextMenu.style.display = 'none';
            messagesEl.innerHTML = '<div style="color: var(--muted); text-align:center; padding-top: 20px;">Ładowanie wiadomości...</div>';

            if (type === 'dm') {
                chatTitle.textContent = id;
                chatSub.textContent = 'Prywatna rozmowa';
                const avatarHtml = `<div>${id.slice(0, 2).toUpperCase()}</div>`;
                chatAvatar.innerHTML = avatarHtml;
                chatTitle.style.cursor = 'default';
            } else {
                const groupRef = ref(db, `groups/${id}`);
                const groupDataSnap = await get(groupRef);
                if (groupDataSnap.exists()) {
                    const groupData = groupDataSnap.val();
                    chatTitle.textContent = groupData.name;
                    chatSub.textContent = `${groupData.members.length} członków`;
                    chatAvatar.innerHTML = `<div>#</div>`;
                    if (groupData.owner === currentUser) {
                        deleteGroupBtn.style.display = 'block';
                    }
                    membersPanel.style.display = 'flex';
                    loadMembersPanel(groupData.members, groupData.owner);
                }
                chatTitle.style.cursor = 'pointer';
            }
            loadMessages();
        }

        function loadMembersPanel(members, owner) {
            membersList.innerHTML = '';
            for (const member of members) {
                const item = document.createElement('div');
                item.className = 'member-item';
                const isOwner = member === owner;
                const avatar = `
                    <div class="avatar">
                        <div>${member.slice(0, 2).toUpperCase()}</div>
                        <span class="avatar-status-dot" style="background:gray"></span>
                    </div>
                `;
                const nameAndStatus = `
                    <div class="member-info">
                        <div class="name-container">
                            <span class="name">${member}</span>
                            ${isOwner ? '<span class="owner-badge">👑</span>' : ''}
                        </div>
                        <div class="member-status">
                            <span class="member-status-text">Offline</span>
                        </div>
                    </div>
                `;
                item.innerHTML = avatar + nameAndStatus;
                item.onclick = () => showProfile(member);
                membersList.appendChild(item);
            }
            
            if (unsubscribeGroupMembersListener) {
                unsubscribeGroupMembersListener();
            }

            const statusRef = ref(db, 'status');
            unsubscribeGroupMembersListener = onValue(statusRef, (snapshot) => {
                const allStatuses = snapshot.val() || {};
                const statusesToUpdate = {};
                members.forEach(member => {
                    statusesToUpdate[member] = allStatuses[member] || 'Offline';
                });
                updateMemberStatuses(statusesToUpdate);
            });
        }

        chatTitle.addEventListener('dblclick', async () => {
            if (currentChatType === 'group' && currentChatId) {
                const currentName = chatTitle.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'chat-title-input';
                input.value = currentName;
                input.style.width = `${currentName.length * 1.2}ch`;

                chatTitle.replaceWith(input);
                input.focus();

                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        const newName = input.value.trim();
                        if (newName.length < 3) {
                            alert('Nazwa grupy musi mieć co najmniej 3 znaki.');
                            input.replaceWith(chatTitle);
                            chatTitle.textContent = currentName;
                            return;
                        }

                        const groupRef = ref(db, `groups/${currentChatId}`);
                        await update(groupRef, { name: newName });
                        
                        input.replaceWith(chatTitle);
                        chatTitle.textContent = newName;
                    }
                });

                input.addEventListener('blur', () => {
                    input.replaceWith(chatTitle);
                    chatTitle.textContent = currentName;
                });
            }
        });

        function loadMessages() {
            if (!currentChatId) return;
            const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
            const chatRef = ref(db, messagesPath);

            unsubscribeMessageListener = onValue(chatRef, snap => {
                messagesEl.innerHTML = '';
                if (snap.exists()) {
                    const messages = snap.val();
                    const messageKeys = Object.keys(messages);

                    messageKeys.forEach(msgId => {
                        const msg = messages[msgId];
                        const isMe = msg.from === currentUser;
                        
                        if (msg.isSystem) {
                            const systemMsgEl = document.createElement('div');
                            systemMsgEl.className = 'system-message';
                            systemMsgEl.textContent = msg.text;
                            messagesEl.appendChild(systemMsgEl);
                            return;
                        }

                        const container = document.createElement('div');
                        container.className = `msg-container ${isMe ? 'me' : ''}`;
                        const av = document.createElement('div');
                        av.className = 'avatar';
                        av.innerHTML = `<div>${msg.from.slice(0, 2).toUpperCase()}</div>`;
                        const div = document.createElement('div');
                        div.className = 'msg' + (isMe ? ' me' : '');
                        div.setAttribute('data-id', msgId);

                        let content;
                        if (msg.status === 'deleted') {
                            content = `<span class="deleted-msg">Cofnięto wysyłanie wiadomości</span>`;
                        } else {
                            const date = new Date(msg.timestamp);
                            const timeString = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                            content = `<div class="msg-info"><span>${msg.from}</span> <span class="timestamp">${timeString}</span></div>`;
                            if (msg.isImage) {
                                content += `<img src="${msg.text}" alt="Image" onclick="window.open(this.src)" />`;
                            } else if (msg.isGif) {
                                content += `<img src="${msg.text}" alt="GIF" onclick="window.open(this.src)" />`;}
                            else {
                                content += msg.text || '';
                            }
                        }

                        div.innerHTML = content;
                        container.appendChild(av);
                        container.appendChild(div);
                        messagesEl.appendChild(container);

                        if (isMe && msg.status !== 'deleted') {
                            div.addEventListener('contextmenu', e => {
                                e.preventDefault();
                                showContextMenu(e, msgId);
                            });
                        }
                    });
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                } else {
                    messagesEl.innerHTML = '<div style="color: var(--muted); text-align:center;">Rozpocznij konwersację.</div>';
                }
            }, (error) => {
                console.error("Firebase Read Error:", error);
                messagesEl.innerHTML = '<div>Błąd ładowania wiadomości. Sprawdź uprawnienia.</div>';
                if (error.code === 'PERMISSION_DENIED') {
                    console.log("Permission denied for path:", messagesPath);
                }
            });
        }

        function showContextMenu(e, msgId) {
            contextMenu.style.display = 'block';
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            activeMessageId = msgId;
        }

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && e.target.className !== 'msg') {
                contextMenu.style.display = 'none';
            }
        });

        deleteMsgItem.onclick = async () => {
            if (activeMessageId) {
                const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
                const messageRef = ref(db, `${messagesPath}/${activeMessageId}`);
                try {
                    await update(messageRef, { text: null, status: 'deleted', isImage: false, isGif: false });
                } catch (error) {
                    alert("Wystąpił błąd podczas usuwania wiadomości. Sprawdź uprawnienia.");
                    console.error("Error deleting message:", error);
                }
                contextMenu.style.display = 'none';
            }
        };

        sendMsgBtn.onclick = async () => {
            const text = msgInput.value.trim();
            if (!text || !currentChatId) return;

            const isImage = /\.(jpg|jpeg|png|webp|avif|gif)$/i.test(text);
            const isGif = /\.(gif)$/i.test(text);

            const message = {
                from: currentUser,
                text: text,
                timestamp: Date.now(),
                isImage: isImage,
                isGif: isGif
            };

            const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
            try {
                await push(ref(db, messagesPath), message);
                msgInput.value = '';
            } catch (error) {
                alert("Błąd wysyłania wiadomości. Sprawdź połączenie lub uprawnienia.");
                console.error("Error sending message:", error);
            }
        };

        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMsgBtn.click();
            }
        });

        const loggedInUser = localStorage.getItem('currentUser');
        if (loggedInUser) {
            loginAs(loggedInUser);
        } else {
            authModal.style.display = 'flex';
        }

        /* ======= MOJE DODATKI JS (RESPONSYWNE ZACHOWANIE NA MOBILE) ======= */

        // referencje do elementów (nie nadpisują istniejącej logiki)
        const sidebar = document.querySelector('.sidebar');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop') || document.querySelector('.sidebar-backdrop');

        // przyciski mobilne (istnieją w HTML dodane powyżej)
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const toggleMembersBtn = document.getElementById('toggleMembers');

        // funkcja wykrywająca mobile (oparta o szerokość) i ustawiająca klasę
        function updateDeviceClass() {
            if (window.matchMedia('(max-width: 768px)').matches) {
                document.body.classList.add('is-mobile');
                // zamknij panele przy wejściu w mobile, żeby nie zostały otwarte
                sidebar && sidebar.classList.remove('active');
                membersPanel && membersPanel.classList.remove('active');
                sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
            } else {
                document.body.classList.remove('is-mobile');
                // upewnij się, że backdrop i panele są zamknięte na desktopie
                sidebar && sidebar.classList.remove('active');
                membersPanel && membersPanel.classList.remove('active');
                sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
            }
        }
        updateDeviceClass();
        window.addEventListener('resize', updateDeviceClass);

        // toggle sidebar (hamburger)
        if (toggleSidebarBtn) {
            toggleSidebarBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!sidebar) return;
                const willOpen = !sidebar.classList.contains('active');
                if (willOpen) {
                    sidebar.classList.add('active');
                    sidebarBackdrop && sidebarBackdrop.classList.add('visible');
                } else {
                    sidebar.classList.remove('active');
                    sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
                }
            });
        }

        // toggle members panel
        if (toggleMembersBtn) {
            toggleMembersBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const willOpen = !membersPanel.classList.contains('active');
                if (willOpen) {
                    membersPanel.classList.add('active');
                    sidebarBackdrop && sidebarBackdrop.classList.add('visible');
                } else {
                    membersPanel.classList.remove('active');
                    sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
                }
            });
        }

        // kliknięcie w backdrop zamyka panele
        if (sidebarBackdrop) {
            sidebarBackdrop.addEventListener('click', () => {
                sidebar && sidebar.classList.remove('active');
                membersPanel && membersPanel.classList.remove('active');
                sidebarBackdrop.classList.remove('visible');
            });
        }

        // gdy klikniesz znajomego lub grupę na mobile, ukryj sidebar (żeby widać chat)
        document.addEventListener('click', (e) => {
            if (window.matchMedia('(max-width: 768px)').matches) {
                const friendEl = e.target.closest('.friend-item');
                const groupEl = e.target.closest('.group-item');

                if (friendEl || groupEl) {
                    // jeśli kliknięcie było w prawy obszar akcji (np. delete) to nie zamykamy
                    if (e.target.closest('.right-actions')) return;

                    sidebar && sidebar.classList.remove('active');
                    sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
                }
            }
        });

<script src="protect.js"></script>
    </script>
</body>
</html>


