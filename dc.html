
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Discord - Friends & Groups</title>
    <style>
        /* ======== TWÓJ ORYGINALNY CSS (bez zmian) ======== */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

/* Odświeżone zmienne kolorów i stylów */
:root {
    /* Tło - ciemniejszy i głębszy granat */
    --bg: #18192A;
    /* Panele - lżejsze i bardziej "szklane" */
    --panel: rgba(40, 42, 61, 0.7); /* Zmiana na rgba dla efektu szkła */
    /* Tekst wyciszony */
    --muted: #b0b0c2;
    /* Akcent - żywy, energetyczny fioletowo-niebieski */
    --accent: #7a6fff;
    /* Efekt szkła - subtelniejszy i z lekkim rozmyciem */
    --glass: rgba(255, 255, 255, 0.08);
    /* Subtelna granica - jaśniejsza i bardziej widoczna dla separacji */
    --subtle-border: rgba(255, 255, 255, 0.15);
    /* Kolory statusów */
    --green: #48c78e;
    --yellow: #ffdd57;
    --red: #ff3860;
    --speaking: #3e8ed0;
    --gaming: #a879e6; /* Nowy kolor dla gamingu */
    --offline: #6f7180;
}

/* Globalne style */
* {
    box-sizing: border-box;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    margin: 0;
    font-family: 'Roboto', sans-serif;
    /* Zastosowanie tła i lekkiego gradientu na body */
    background: var(--bg);
    background-image: radial-gradient(circle at 10% 20%, rgba(30, 30, 50, 0.2) 0%, transparent 80%);
    color: white;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* Dodajemy wsparcie dla glassmorphism */
    backdrop-filter: blur(0px); 
    -webkit-backdrop-filter: blur(0px);
}

.container {
    display: flex;
    flex: 1;
    overflow: hidden;
    border-radius: 20px; /* Większe zaokrąglenie */
    margin: 20px; /* Większy margines */
    /* Nowy, bardziej elegancki cień */
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
    /* Dodajemy efekt rozmycia dla głównego kontenera */
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
}

.sidebar, .main, .members-panel {
    padding: 20px; /* Większy padding */
    display: flex;
    flex-direction: column;
    gap: 20px; /* Większy odstęp */
}

.sidebar {
    width: 300px; /* Nieco szerszy sidebar */
    background: var(--panel);
    overflow-y: auto;
    flex-shrink: 0;
    border-right: 1px solid var(--subtle-border);
    /* Lekki wewnętrzny cień dla głębi */
    box-shadow: inset -1px 0 5px rgba(0, 0, 0, 0.1);
}

.main {
    flex: 1;
    background: transparent; /* Główna zawartość ma przezroczyste tło, by było widać blur z .container */
    min-width: 300px;
}

.members-panel {
    width: 260px; /* Nieco węższy panel członków */
    background: var(--panel);
    overflow-y: auto;
    flex-shrink: 0;
    border-left: 1px solid var(--subtle-border);
    display: none;
    /* Lekki wewnętrzny cień dla głębi */
    box-shadow: inset 1px 0 5px rgba(0, 0, 0, 0.1);
}
        
.profile-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--panel);
    padding: 30px; /* Większy padding */
    border-radius: 20px; /* Większe zaokrąglenie */
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
    z-index: 200;
    display: none;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 16px; /* Większy odstęp */
    width: 350px; /* Nieco szerszy modal */
    animation: fadeIn 0.3s ease-out;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2); /* Szklana ramka */
}

@keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -40%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
}
        
.profile-modal h3 {
    margin: 0;
    font-weight: 700;
    font-size: 1.5em; /* Większy tytuł */
}

/* Nowe, nowoczesne inputy i buttony */
input, button {
    font-family: inherit;
    border-radius: 12px; /* Bardziej zaokrąglone */
    border: none;
    background: var(--glass);
    color: white;
    padding: 14px 18px; /* Większy padding */
    transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
    font-size: 1em;
}

input::placeholder {
    color: var(--muted);
}

input:focus {
    outline: 2px solid var(--accent); /* Nowa, wyraźna ramka po focusie */
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 2px var(--accent);
}

button {
    cursor: pointer;
    /* Gradientowy przycisk akcentujący */
    background: linear-gradient(90deg, #7a6fff, #5e7bff);
    font-weight: 500;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--accent);
}
/* Konec przycisków */

.profile {
    display: flex;
    align-items: center;
    gap: 16px; /* Większy odstęp */
    padding-bottom: 20px;
    border-bottom: 2px solid var(--subtle-border); /* Grubsza linia */
    position: relative;
}

.avatar {
    width: 50px; /* Większy awatar */
    height: 50px;
    border-radius: 50%;
    /* Odświeżony gradient */
    background: linear-gradient(135deg, #7a6fff, #5e7bff);
    border: 3px solid rgba(255, 255, 255, 0.2); /* Subtelna ramka wokół awatara */
    box-shadow: 0 0 0 2px var(--panel);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    overflow: hidden;
    flex-shrink: 0;
    position: relative;
    transition: transform 0.2s;
}

.avatar:hover {
    transform: scale(1.05);
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}
        
/* POPRAWKA 1: Ustawienie kropki statusu tak, by nie chowała się za ramką */
.avatar-status-dot {
    position: absolute;
    bottom: -1px; /* Przesunięcie nieco wyżej */
    right: -1px; /* Przesunięcie nieco do środka */
    width: 14px; /* Większa kropka */
    height: 14px;
    border-radius: 50%;
    border: 3px solid var(--panel); /* Ramka w kolorze panelu dla kontrastu */
    z-index: 10; /* Upewnienie się, że jest nad wszystkim */
}

/* POPRAWKA 2: Status w panelu członków musi być na wierzchu */
.member-item .avatar-status-dot {
    border: 2px solid var(--panel); /* Trochę cieńsza ramka w panelu członków */
    z-index: 11; /* Jeszcze wyższy z-index, aby na pewno był nad awatarem */
}
/* KONIEC POPRAWKI STATUSU */

.avatar.profile-modal-avatar {
    width: 90px; /* Jeszcze większy w modal */
    height: 90px;
    font-size: 28px;
}

.nick {
    font-weight: 700;
    font-size: 1.2em; /* Większy nick */
    cursor: pointer;
    transition: color 0.2s;
}
.nick:hover {
    color: var(--accent);
}
        
.nick-input {
    background: transparent;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1.2em;
    padding: 0;
    margin: 0;
    outline: none;
    max-width: 150px;
}

/* Poprawa dropdown statusu */
.status-dropdown {
    position: relative;
    margin-top: 6px;
    cursor: pointer;
    width: fit-content;
}

.status-selected {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--muted);
    padding: 6px 10px;
    border-radius: 8px;
    background: var(--glass);
    transition: background 0.2s;
}

.status-selected:hover {
    background: rgba(255, 255, 255, 0.15);
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.status-options {
    position: absolute;
    top: 100%;
    left: 0;
    width: 180px; /* Szerszy dropdown */
    background: #313349; /* Ciemniejsze tło niż panel, by się wyróżniało */
    border-radius: 12px; /* Zaokrąglone rogi */
    overflow: hidden;
    display: none;
    flex-direction: column;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
    z-index: 100;
    transform: translateY(10px);
    border: 1px solid var(--subtle-border);
}

.status-options div {
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background 0.1s;
}

.status-options div:hover {
    background: var(--accent);
    color: white;
}
/* Koniec dropdownu */

.logoutBtn {
    background: none;
    color: var(--muted);
    font-size: 24px; /* Większa ikona */
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    padding: 8px;
    transition: color 0.2s;
}

.logoutBtn:hover {
    color: var(--red);
    transform: translateY(-50%) scale(1.1); /* Lekka animacja */
}

.section-divider {
    height: 2px; /* Grubsza linia */
    background: var(--subtle-border);
    margin: 0;
}

.friends-list, .groups-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px; /* Większy odstęp */
}

/* Odświeżone listy elementów */
.friend-item, .group-item, .request-item, .member-item {
    display: flex;
    align-items: center;
    padding: 12px 15px; /* Większy padding */
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03); /* Subtelniejsze tło */
    cursor: pointer;
    transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
    border: 1px solid transparent;
}

.friend-item:hover, .group-item:hover, .request-item:hover, .member-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: none; /* Usuwamy przesunięcie w górę, by uniknąć migotania na listach */
    box-shadow: 0 0 0 1px var(--accent); /* Podświetlenie akcentem */
}
/* Koniec list elementów */

.friend-item .avatar, .group-item .avatar, .request-item .avatar, .member-item .avatar {
    width: 40px; /* Większe awatary na liście */
    height: 40px;
    font-size: 15px;
    margin-right: 15px;
}

.friend-item .name, .group-item .name, .request-item .name, .member-item .name {
    font-weight: 600;
    font-size: 1.05em;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    /* Zmniejszamy max-width, by zrobić miejsce na ikony */
    max-width: 100px; /* Zwiększone, by dać więcej miejsca na nazwę */
    flex-grow: 1; /* Pozwalamy, by nazwa zajęła dostępną przestrzeń */
}

.group-item .avatar {
    background: linear-gradient(135deg, #a879e6, #5c6bc0); /* Nowy gradient dla grup */
}

.small-muted {
    font-size: 13px;
    color: var(--muted);
}

.friend-item .right-actions, .request-item .right-actions {
    margin-left: auto;
    display: flex;
    gap: 8px; /* Mniejszy odstęp między ikonami */
    flex-shrink: 0;
    align-items: center;
}

/* POPRAWKA 3: Przywrócenie widocznych, okrągłych przycisków akcji (DM/USUŃ/AKCEPTUJ) */
.dm-btn, .delete-btn, .accept {
    /* Ustawienia wspólne dla małych przycisków ikonek */
    padding: 8px;
    width: 38px; /* Optymalny rozmiar */
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* Okrągły kształt */
    font-size: 16px; 
    transition: background 0.2s, color 0.2s, transform 0.1s, box-shadow 0.2s;
    font-weight: 400;
    color: white; /* Biała ikona na kolorowym tle */
    border: none;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.dm-btn {
    background: var(--accent); /* Wyraźne tło akcentu dla DM */
}
.dm-btn:hover {
    background: #6a5eff; /* Lżejszy kolor na hover */
    transform: scale(1.05);
}

.delete-btn {
    background: var(--red); /* Czerwony kolor dla 'usuń' */
}
.delete-btn:hover {
    background: #e63255;
    transform: scale(1.05);
}

.accept {
    background: var(--green); /* Zielony kolor dla 'akceptuj' */
}
.accept:hover {
    background: #3eb27e;
    transform: scale(1.05);
}
/* KONIEC POPRAWKI przycisków akcji */

.chat-header {
    padding-bottom: 20px;
    border-bottom: 2px solid var(--subtle-border);
    display: flex;
    align-items: center;
    gap: 20px;
    position: relative;
}

.chat-header .avatar {
    width: 55px;
    height: 55px;
    font-size: 20px;
}

.chat-title {
    font-weight: 700;
    font-size: 24px;
    cursor: pointer;
}

.chat-title-input {
    background: transparent;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 24px;
    padding: 0;
    margin: 0;
    outline: none;
}

.chat-sub {
    font-size: 16px;
    color: var(--muted);
}

/* Przycisk usuwania grupy (bez animacji) */
.delete-group-btn {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: var(--red);
    padding: 10px 18px;
    border-radius: 10px;
    transition: background 0.3s, box-shadow 0.3s; 
}

.delete-group-btn:hover {
    background: #e63255; 
    box-shadow: 0 4px 10px rgba(255, 56, 96, 0.4);
}
/* KONIEC przycisku usuwania grupy */

.messages {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px; /* Większy odstęp między wiadomościami */
}

.msg-container {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    position: relative;
    /* Animacja wejścia wiadomości - subtelne pojawienie się */
    animation: messageEntry 0.2s ease-out;
}

@keyframes messageEntry {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.msg-container.me {
    flex-direction: row-reverse;
}

.msg-container .avatar {
    width: 36px; /* Nieco większy awatar */
    height: 36px;
    background: #3e8ed0; /* Nowy kolor awatara po lewej */
    border: none;
}

.msg-container.me .avatar {
    background: #7a6fff; /* Awatar nadawcy w akcencie */
}

.msg {
    max-width: 65%; /* Nieco węższa, by zostawić miejsce */
    padding: 14px 20px;
    border-radius: 24px; /* Bardziej zaokrąglone */
    background: rgba(255, 255, 255, 0.1);
    word-wrap: break-word;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    transition: transform 0.1s;
}

.msg:hover {
    transform: scale(1.005);
}

.msg.me {
    background: linear-gradient(135deg, var(--accent), #5e7bff);
    color: white;
    border-top-right-radius: 10px; /* Asymetryczne rogi */
}

.msg:not(.me) {
    border-top-left-radius: 10px; /* Asymetryczne rogi */
}

.msg-info {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
    font-weight: 500;
}

.msg-info .timestamp {
    margin-left: 8px;
    font-weight: 300; /* Lżejsza czcionka dla czasu */
}

.msg.me .msg-info {
    color: rgba(255, 255, 255, 0.85);
}

.composer {
    display: flex;
    width: 100%;
    gap: 12px;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid var(--subtle-border);
}

.composer input[type=text] {
    flex: 1;
    border-radius: 28px; /* Bardziej zaokrąglone */
    padding: 14px 20px;
}

/* Przycisk wyślij - zaokrąglony prostokąt (bez zmian od ostatniej wersji) */
.composer button {
    border-radius: 14px; 
    padding: 12px 18px; 
    width: auto; 
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1em; 
    flex-shrink: 0;
}

/* Poprawa modalu autoryzacji */
.auth-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85); /* Ciemniejsze tło */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

.auth-card {
    background: #232537;
    padding: 40px;
    border-radius: 20px;
    width: 400px; /* Nieco szersza karta */
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.auth-card h3 {
    text-align: center;
    margin: 0;
    font-size: 1.8em;
    font-weight: 700;
    color: white;
}

.auth-card .toggle-btn {
    background: none;
    color: var(--accent);
    font-weight: 500;
    font-size: 15px;
    text-align: center;
    cursor: pointer;
    padding: 0;
    transition: color 0.2s;
}

.auth-card .toggle-btn:hover {
    color: #a89eff;
    text-decoration: none;
}

.auth-card .auth-form {
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.auth-card .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.auth-card .form-group label {
    font-size: 15px;
    color: var(--muted);
    font-weight: 500;
}
/* Koniec modalu autoryzacji */

/* Poprawa przełącznika z zaproszeniami */
.requests-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.05);
    padding: 14px;
    border-radius: 12px;
    transition: background 0.2s, box-shadow 0.2s;
    font-weight: 500;
    font-size: 1.1em;
}
.requests-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 0 1px var(--accent);
}

.requests-list {
    display: none;
    flex-direction: column;
    gap: 10px;
}

.requests-count {
    background: var(--accent);
    color: white;
    border-radius: 14px;
    padding: 4px 10px;
    font-size: 13px;
    font-weight: 700;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.active-users-info {
    font-size: 15px;
    color: var(--muted);
}

/* POPRAWKA: Zmniejszenie kreatora grup */
.group-creator {
    display: flex;
    flex-direction: column;
    gap: 10px; /* Zmniejszony odstęp */
    padding: 12px; /* Zmniejszony padding */
    border: 2px dashed var(--subtle-border);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.03);
}

.group-creator .checkbox-list {
    max-height: 180px; /* Niższa lista */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px; /* Zmniejszony odstęp */
    padding-right: 8px; /* Miejsce na scrollbar */
}

.group-creator label {
    display: flex;
    align-items: center;
    gap: 8px; /* Zmniejszony odstęp */
    font-size: 14px; /* Zmniejszona czcionka */
    color: var(--muted);
    transition: color 0.2s;
}
.group-creator label:hover {
    color: white;
}

.group-creator input[type="checkbox"] {
    width: 18px; /* Mniejszy checkbox */
    height: 18px;
    padding: 0;
    border-radius: 4px;
    accent-color: var(--accent); /* Kolor dla zaznaczenia */
    flex-shrink: 0;
    cursor: pointer;
}
/* KONIEC POPRAWKI CREATORA GRUP */

.msg img, .msg video {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin-top: 8px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.system-message {
    text-align: center;
    font-style: italic;
    color: var(--muted);
    font-size: 14px;
    padding: 8px 0;
}

/* Paski przewijania - jaśniejsze i bardziej dyskretne */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
    background-color: transparent;
}
::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
}
::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.25);
    border-radius: 5px;
    border: 2px solid var(--panel);
}
::-webkit-scrollbar-thumb:hover {
    background: var(--accent); /* Akcent przy najechaniu */
}

/* Menu kontekstowe - nowoczesny wygląd */
.context-menu {
    display: none;
    position: fixed;
    background: #313349;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
    padding: 10px 0;
    z-index: 100;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.context-menu-item {
    padding: 12px 20px;
    color: white;
    font-size: 15px;
    cursor: pointer;
    white-space: nowrap;
    transition: background 0.1s, color 0.1s;
}

.context-menu-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.context-menu-item.delete {
    color: var(--red);
}
.context-menu-item.delete:hover {
    background: var(--red);
    color: white;
}

.deleted-msg {
    font-style: italic;
    color: var(--muted);
    font-size: 14px;
}

/* Członkowie panelu - ulepszone */
.members-panel h4 {
    margin: 0;
    color: var(--muted);
    font-size: 1em;
    font-weight: 500;
}

.member-list {
    display: flex;
    flex-direction: column;
    gap: 6px; /* Mniejszy odstęp dla gęstszej listy */
}

.member-item {
    background: none;
    padding: 8px 10px;
    border: 1px solid transparent;
}

.member-item:hover {
    transform: none;
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

.member-info {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.member-item .name-container {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
}

.member-status {
    font-size: 12px;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 2px;
}

.status-badge {
    font-size: 11px;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
    background: rgba(255, 255, 255, 0.15);
    color: white;
}

.owner-badge {
    color: var(--yellow);
    margin-left: 8px;
    font-size: 1.1em;
}

/* === REGUŁY RESPONSYWNE === */

/* Responsywność - oryginalna sekcja (zostaje) */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
    }

    /* Sidebar na górze */
    .sidebar {
        order: -1;
        width: 100%;
        max-height: none;
        border: none;
        border-bottom: 1px solid var(--subtle-border);
        box-shadow: none;
    }

    /* Ukrywamy panel członków */
    .members-panel {
        display: none;
        box-shadow: none;
    }

    .main {
        flex: 1;
        width: 100%;
        min-height: 60vh;
        padding-top: 12px; /* Mniejszy górny padding na mobilnym */
        padding-bottom: 80px; /* Zapas dla composera na dole */
    }

    .chat-header {
        position: sticky;
        top: 0;
        background: var(--bg);
        z-index: 10;
        padding: 16px 0;
        margin-bottom: 0;
    }

    /* Wiadomości – większa szerokość */
    .msg {
        max-width: 90%;
    }

    /* Composer – lepsze rozmieszczenie */
    .composer {
        flex-direction: row;
        gap: 8px;
    }

    .composer input[type=text] {
        font-size: 1em;
        padding: 12px 18px;
    }
}

/* Bardzo małe ekrany (np. starsze telefony) */
@media (max-width: 480px) {
    /* Modal profilu dopasowany do ekranu */
    .profile-modal {
        width: 95%;
        padding: 20px;
    }

    /* Karta logowania/rejestracji */
    .auth-card {
        width: 95%;
        padding: 25px;
        gap: 15px;
    }
    .auth-card h3 {
        font-size: 1.6em;
    }

    /* Tytuły i teksty trochę mniejsze */
    .chat-title {
        font-size: 20px;
    }

    .chat-sub {
        font-size: 14px;
    }

    /* Przycisk wyślij na mobilnym - mniejszy i kwadratowy */
    .composer button {
        width: 45px;
        height: 45px;
        padding: 12px;
        border-radius: 12px;
        font-size: 1em;
    }

    .msg-container .avatar {
        width: 32px;
        height: 32px;
    }
}

/* ======== DODATKOWE REGUŁY MOBILNE (nadpisujące i poprawiające UX na tel) ======== */

/* ustawiamy mobile buttony ukryte domyślnie - pokażą się w @media */
.mobile-btn { display: none; }

@media (max-width: 768px) {
    /* lepsze przewijanie na touch */
    .friends-list, .groups-list, .messages, .sidebar, .members-panel, .requests-list {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        overflow-y: auto;
        -ms-overflow-style: auto;
    }

    /* Sidebar wysuwany z lewej (domyślnie ukryty) */
    .sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        height: 100%;
        width: 85%; /* Szerszy na mobile */
        max-width: 340px;
        background: var(--bg); /* Lżejsze tło dla wysuwanego menu */
        z-index: 1300;
        overflow-y: auto;
        border-right: none;
        border-left: none;
        border-bottom: none;
        box-shadow: 2px 0 20px rgba(0,0,0,0.6);
        transition: left 0.28s cubic-bezier(0.4, 0.0, 0.2, 1);
        padding-top: 40px; /* Miejsce na status bar */
    }
    .sidebar.active {
        left: 0;
    }

    /* Members panel wysuwany z prawej */
    .members-panel {
        position: fixed;
        top: 0;
        right: -100%;
        height: 100%;
        width: 85%;
        max-width: 340px;
        background: var(--bg);
        z-index: 1300;
        overflow-y: auto;
        box-shadow: -2px 0 20px rgba(0,0,0,0.6);
        transition: right 0.28s cubic-bezier(0.4, 0.0, 0.2, 1);
        padding-top: 40px;
    }
    .members-panel.active {
        right: 0;
        display: flex;
    }

    /* backdrop za wysuwanymi panelami */
    .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6); /* Ciemniejszy cień */
        z-index: 1250;
        display: none;
        backdrop-filter: blur(2px);
    }
    .sidebar-backdrop.visible { display: block; }

    /* pokaż przyciski mobilne */
    .mobile-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        background: none;
        border: none;
        font-size: 24px; /* Większe ikony */
        color: white;
        padding: 8px;
        border-radius: 10px;
        transition: background 0.1s;
    }
    .mobile-btn:active, .mobile-btn:focus {
        outline: none;
        background: rgba(255,255,255,0.1);
    }

    /* main zajmuje cały ekran */
    .container {
        margin: 0;
        border-radius: 0;
        height: 100vh;
    }
    .main {
        width: 100%;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 16px; /* Właściwe paddingi dla głównej treści */
    }

    .chat-header {
        padding: 12px 0; /* Paddingi już są w main */
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* Composer poprawiony */
    .composer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #18192A; /* Pełne tło dla composera */
        padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
        z-index: 2000;
        border-top: 1px solid var(--subtle-border);
        box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
    }

    /* Zapas miejsca pod composerem */
    .messages {
        padding-bottom: 80px;
    }

    .msg {
        max-width: 92%;
    }

    /* mniejsze pady w sidebar, żeby zmieścić więcej */
    .profile, .requests-toggle, .group-creator {
        padding: 12px;
    }

    .friends-list, .groups-list {
        gap: 10px;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="profile">
                <div class="avatar" id="meAvatar">--</div>
                <div>
                    <div class="nick" id="meNick">Zaloguj się</div>
                    <div class="status-dropdown" id="statusDropdown">
                        <div class="status-selected" id="statusSelected">
                            <span class="status-dot" style="background:gray"></span> Offline
                        </div>
                        <div class="status-options" id="statusOptions">
                            <div data-status="Online"><span class="status-dot" style="background:green"></span> Online</div>
                            <div data-status="Zaraz wracam"><span class="status-dot" style="background:yellow"></span> Zaraz wracam</div>
                            <div data-status="Nie przeszkadzać"><span class="status-dot" style="background:red"></span> Nie przeszkadzać</div>
                            <div data-status="Offline"><span class="status-dot" style="background:gray"></span> Offline</div>
                        </div>
                    </div>
                </div>
                <button class="logoutBtn" id="logoutBtn" style="display:none">🚪</button>
            </div>

            <div class="requests-toggle" id="requestsToggle">
                <h4 style="color:var(--muted); margin:0;">Zaproszenia</h4>
                <span class="requests-count" id="requestsCount">0</span>
            </div>
            <div class="requests-list" id="requestsList"></div>

            <hr class="section-divider">

            <h4 style="color:var(--muted); margin:0;">Znajomi</h4>
            <input id="addFriendInput" placeholder="Dodaj znajomego..." />
            <button id="addFriendBtn">Dodaj</button>
            <div class="friends-list" id="friendsList"></div>

            <hr class="section-divider">

            <h4 style="color:var(--muted); margin:0;">Grupy</h4>
            <button id="createGroupBtn">Stwórz grupę</button>
            <div class="groups-list" id="groupsList"></div>

            <div class="group-creator" id="groupCreator" style="display:none;">
                <label>Nazwa grupy:</label>
                <input id="groupNameInput" placeholder="Nazwa grupy" />
                <label>Uczestnicy:</label>
                <div class="checkbox-list" id="groupFriendsList"></div>
                <button id="confirmCreateGroupBtn">Stwórz</button>
                <button id="cancelCreateGroupBtn">Anuluj</button>
            </div>
        </div>

        <div class="main">
            <!-- DODAŁEM PRZYCISKI MOBILNE (☰ i 👥) - będą widoczne tylko na telefonie -->
            <div class="chat-header">
                <button id="toggleSidebar" class="mobile-btn" aria-label="menu">☰</button>

                <div class="avatar" id="chatAvatar">?</div>
                <div>
                    <div class="chat-title" id="chatTitle">Wybierz znajomego</div>
                    <div class="chat-sub" id="chatSub">Prywatna rozmowa</div>
                </div>

                <!-- przycisk otwierający panel członków na mobile -->
                <button id="toggleMembers" class="mobile-btn" aria-label="members">👥</button>

                <button id="deleteGroupBtn" class="delete-group-btn" style="display:none;">Usuń grupę</button>
            </div>
            <div class="messages" id="messages"></div>
            <div class="composer">
                <input type="text" id="msgInput" placeholder="Napisz wiadomość... lub wklej link do obrazka/GIF-a" autocomplete="off" />
                <button id="sendMsgBtn">Wyślij</button>
            </div>
        </div>
        
        <div class="members-panel" id="membersPanel">
            <h4 id="membersPanelTitle">Członkowie</h4>
            <div id="membersList" class="member-list"></div>
        </div>
        
    </div>

    <!-- backdrop używany na mobile gdy wysunięty sidebar/members -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <div class="profile-modal" id="profileModal">
        <div class="avatar profile-modal-avatar" id="profileAvatar">?</div>
        <h3 id="profileNick"></h3>
        <div id="profileStatus"></div>
        <div id="profileJoinDate" class="small-muted"></div>
    </div>

    <div class="auth-modal" id="authModal">
        <div class="auth-card">
            <div id="loginForm">
                <h3>Logowanie</h3>
                <div class="auth-form">
                    <div class="form-group">
                        <label for="logNick">Nick</label>
                        <input id="logNick" placeholder="Twój nick">
                    </div>
                    <div class="form-group">
                        <label for="logPass">Hasło</label>
                        <input id="logPass" type="password" placeholder="Twoje hasło">
                    </div>
                    <button id="btnLogin">Zaloguj się</button>
                </div>
                <button class="toggle-btn" id="showRegBtn">Nie masz konta? Zarejestruj się</button>
            </div>
            <div id="registerForm" style="display:none;">
                <h3>Rejestracja</h3>
                <div class="auth-form">
                    <div class="form-group">
                        <label for="regNick">Nick</label>
                        <input id="regNick" placeholder="Wybierz nick (max 6 znaków)">
                    </div>
                    <div class="form-group">
                        <label for="regPass">Hasło</label>
                        <input id="regPass" type="password" placeholder="Wybierz hasło">
                    </div>
                    <button id="btnRegister">Zarejestruj się</button>
                </div>
                <button class="toggle-btn" id="showLogBtn">Masz już konto? Zaloguj się</button>
            </div>
        </div>
    </div>

    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item delete" id="deleteMsgItem">Usuń dla wszystkich</div>
    </div>

    

    <!-- ====== TWÓJ ORYGINALNY SKRYPT (bez usuwania) ====== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
  apiKey: "AIzaSyBWtZUr7xoa31uoH18hksqSjCXMd2F18Ew",
  authDomain: "strona-f0d19.firebaseapp.com",
  databaseURL: "https://strona-f0d19-default-rtdb.firebaseio.com",
  projectId: "strona-f0d19",
  storageBucket: "strona-f0d19.firebasestorage.app",
  messagingSenderId: "34203329400",
  appId: "1:34203329400:web:c934bf311237b1a6701e8d",
  measurementId: "G-HYCP5F1J3E"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ===== DOM =====
        const authModal = document.getElementById('authModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegBtn = document.getElementById('showRegBtn');
        const showLogBtn = document.getElementById('showLogBtn');
        const btnRegister = document.getElementById('btnRegister');
        const btnLogin = document.getElementById('btnLogin');
        const regNick = document.getElementById('regNick');
        const regPass = document.getElementById('regPass');
        const logNick = document.getElementById('logNick');
        const logPass = document.getElementById('logPass');
        const meNickEl = document.getElementById('meNick');
        const meAvatar = document.getElementById('meAvatar');
        const statusDropdown = document.getElementById('statusDropdown');
        const statusSelected = document.getElementById('statusSelected');
        const statusOptions = document.getElementById('statusOptions');
        const logoutBtn = document.getElementById('logoutBtn');
        const friendsListEl = document.getElementById('friendsList');
        const addFriendInput = document.getElementById('addFriendInput');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const requestsListEl = document.getElementById('requestsList');
        const requestsToggle = document.getElementById('requestsToggle');
        const requestsCountEl = document.getElementById('requestsCount');
        const chatTitle = document.getElementById('chatTitle');
        const chatSub = document.getElementById('chatSub');
        const chatAvatar = document.getElementById('chatAvatar');
        const messagesEl = document.getElementById('messages');
        const msgInput = document.getElementById('msgInput');
        const sendMsgBtn = document.getElementById('sendMsgBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const groupCreator = document.getElementById('groupCreator');
        const groupNameInput = document.getElementById('groupNameInput');
        const groupFriendsList = document.getElementById('groupFriendsList');
        const confirmCreateGroupBtn = document.getElementById('confirmCreateGroupBtn');
        const cancelCreateGroupBtn = document.getElementById('cancelCreateGroupBtn');
        const groupsListEl = document.getElementById('groupsList');
        const deleteGroupBtn = document.getElementById('deleteGroupBtn');
        const activeUsersCountEl = document.getElementById('activeUsersCount');
        const contextMenu = document.getElementById('contextMenu');
        const deleteMsgItem = document.getElementById('deleteMsgItem');
        const membersPanel = document.getElementById('membersPanel');
        const membersList = document.getElementById('membersList');
        const profileModal = document.getElementById('profileModal');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileNick = document.getElementById('profileNick');
        const profileStatus = document.getElementById('profileStatus');
        const profileJoinDate = document.getElementById('profileJoinDate');

        let currentUser = null;
        let currentChatId = null;
        let currentChatType = null;
        let myStatus = 'Online';
        let activeMessageId = null;
        let unsubscribeMessageListener = null;
        let unsubscribeGroupMembersListener = null;

        // ===== AUTH =====
        showRegBtn.onclick = () => { loginForm.style.display = 'none'; registerForm.style.display = 'block'; };
        showLogBtn.onclick = () => { registerForm.style.display = 'none'; loginForm.style.display = 'block'; };

        btnRegister.onclick = async () => {
            const nick = regNick.value.trim();
            const pass = regPass.value;
            if (!nick || !pass) { alert('Nick i hasło są wymagane.'); return; }
            if (nick.length > 6) {
                alert('Nick może mieć maksymalnie 6 znaków.');
                return;
            }
            const snap = await get(ref(db, 'users/' + nick));
            if (snap.exists()) { alert('Nick jest już zajęty.'); return; }
            await set(ref(db, 'users/' + nick), { password: pass, createdAt: Date.now() });
            loginAs(nick);
        };

        btnLogin.onclick = async () => {
            const nick = logNick.value.trim();
            const pass = logPass.value;
            const snap = await get(ref(db, 'users/' + nick));
            if (!snap.exists() || snap.val().password !== pass) { alert('Błędny nick lub hasło.'); return; }
            loginAs(nick);
        };

        function loginAs(nick) {
            currentUser = nick;
            localStorage.setItem('currentUser', nick);
            authModal.style.display = 'none';
            meNickEl.textContent = nick;
            meAvatar.innerHTML = `<div>${nick.slice(0, 2).toUpperCase()}</div>`;
            logoutBtn.style.display = 'inline-block';
            initPresence();
            startListeners();
            set(ref(db, 'status/' + currentUser), 'Online');
            
            const statusRef = ref(db, 'status/' + currentUser);
            onValue(statusRef, snap => {
                myStatus = snap.val() || 'Offline';
                updateStatusUI(meNickEl.textContent, myStatus);
            });

            meAvatar.onclick = () => showProfile(currentUser);
            meNickEl.onclick = () => showProfile(currentUser);
        }
        
        meNickEl.addEventListener('dblclick', () => {
            const currentNick = meNickEl.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'nick-input';
            input.value = currentNick;
            meNickEl.replaceWith(input);
            input.focus();

            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    const newNick = input.value.trim();
                    if (newNick === currentNick || newNick.length > 6 || newNick.length === 0) {
                        alert('Nieprawidłowy nick. Może mieć maks. 6 znaków i nie może być pusty.');
                        input.replaceWith(meNickEl);
                        meNickEl.textContent = currentNick;
                        return;
                    }

                    const snap = await get(ref(db, 'users/' + newNick));
                    if (snap.exists()) {
                        alert('Nick jest już zajęty.');
                        input.replaceWith(meNickEl);
                        meNickEl.textContent = currentNick;
                        return;
                    }

                    const userRef = ref(db, 'users/' + currentNick);
                    const userData = (await get(userRef)).val();
                    await set(ref(db, 'users/' + newNick), userData);
                    
                    const statusRef = ref(db, 'status/' + currentNick);
                    const statusData = (await get(statusRef)).val();
                    await set(ref(db, 'status/' + newNick), statusData);

                    currentUser = newNick;
                    localStorage.setItem('currentUser', newNick);
                    meNickEl.textContent = newNick;
                    meAvatar.innerHTML = `<div>${newNick.slice(0, 2).toUpperCase()}</div>`;
                    
                    await remove(userRef);
                    await remove(statusRef);
                    
                    input.replaceWith(meNickEl);
                }
            });
        });

        logoutBtn.onclick = () => {
            set(ref(db, 'status/' + currentUser), 'Offline');
            remove(ref(db, 'online/' + currentUser));
            localStorage.removeItem('currentUser');
            location.reload();
        };

        // ===== PRESENCE =====
        function initPresence() {
            if (!currentUser) return;
            const onRef = ref(db, 'online/' + currentUser);
            set(onRef, true);
            onValue(ref(db, 'online'), (snapshot) => {
                const count = snapshot.size;
                activeUsersCountEl.textContent = count;
            });
        }

        // ===== STATUS =====
        statusSelected.onclick = () => { statusOptions.style.display = statusOptions.style.display === 'flex' ? 'none' : 'flex'; };
        statusOptions.querySelectorAll('div').forEach(div => {
            div.onclick = async () => {
                const st = div.dataset.status;
                myStatus = st;
                await set(ref(db, 'status/' + currentUser), st);
                updateStatusUI(meNickEl.textContent, st);
                statusOptions.style.display = 'none';
            };
        });
        function updateStatusUI(userNick, st) {
            const dot = document.getElementById('st_' + userNick) || statusSelected.querySelector('.status-dot');
            const color = st === 'Online' ? 'green' : st === 'Zaraz wracam' ? 'yellow' : st === 'Nie przeszkadzać' ? 'red' : 'gray';
            if (dot) dot.style.background = color;
            if (document.getElementById('st_' + userNick)) {
                 document.getElementById('st_' + userNick).textContent = st;
            }
            if(userNick === currentUser) {
                 statusSelected.innerHTML = `<span class="status-dot" style="background:${color}"></span> ${st}`;
            }
        }

        // ===== FRIENDS & GROUPS =====
        addFriendBtn.onclick = async () => {
            const nick = addFriendInput.value.trim();
            if (!nick || nick === currentUser) { alert('Nieprawidłowy nick.'); return; }
            const s = await get(ref(db, 'users/' + nick));
            if (!s.exists()) { alert('Użytkownik nie istnieje.'); return; }
            const f = await get(ref(db, `friends/${currentUser}/${nick}`));
            if (f.exists()) { alert('Już jesteście znajomymi.'); return; }
            await set(ref(db, `friendRequests/${nick}/${currentUser}`), { from: currentUser, at: Date.now() });
            alert('Wysłano zaproszenie.');
            addFriendInput.value = '';
        };

        createGroupBtn.onclick = async () => {
            const snap = await get(ref(db, `friends/${currentUser}`));
            groupFriendsList.innerHTML = '';
            groupNameInput.value = '';
            if (snap.exists()) {
                snap.forEach(friendSnap => {
                    const friendNick = friendSnap.key;
                    const item = document.createElement('label');
                    item.innerHTML = `<input type="checkbox" value="${friendNick}" /> ${friendNick}`;
                    groupFriendsList.appendChild(item);
                });
                groupCreator.style.display = 'flex';
            } else {
                alert("Musisz mieć znajomych, aby stworzyć grupę.");
            }
        };

        cancelCreateGroupBtn.onclick = () => {
            groupCreator.style.display = 'none';
        };

        confirmCreateGroupBtn.onclick = async () => {
            const groupName = groupNameInput.value.trim();
            const members = [currentUser];
            document.querySelectorAll('#groupFriendsList input:checked').forEach(checkbox => {
                members.push(checkbox.value);
            });

            if (groupName.length < 3) {
                alert('Nazwa grupy musi mieć co najmniej 3 znaki.');
                return;
            }
            if (members.length < 2) {
                alert('Grupa musi mieć co najmniej dwóch uczestników.');
                return;
            }

            const groupKey = push(ref(db, 'groups')).key;
            const groupData = {
                name: groupName,
                members: members,
                owner: currentUser,
                createdAt: Date.now()
            };
            await set(ref(db, `groups/${groupKey}`), groupData);

            for (const member of members) {
                await set(ref(db, `userGroups/${member}/${groupKey}`), true);
            }

            alert('Grupa została stworzona!');
            groupCreator.style.display = 'none';
        };

        async function deleteFriend(friendNick) {
            if (confirm(`Czy na pewno chcesz usunąć ${friendNick} ze znajomych?`)) {
                await remove(ref(db, `friends/${currentUser}/${friendNick}`));
                await remove(ref(db, `friends/${friendNick}/${currentUser}`));
                alert(`${friendNick} został usunięty z listy znajomych.`);
            }
        }

        async function deleteGroup(groupId) {
            if (confirm("Czy na pewno chcesz usunąć tę grupę?")) {
                const groupDataSnap = await get(ref(db, `groups/${groupId}`));
                if (groupDataSnap.exists()) {
                    const groupData = groupDataSnap.val();
                    if (groupData.owner !== currentUser) {
                        alert("Nie jesteś właścicielem tej grupy i nie możesz jej usunąć.");
                        return;
                    }
                    for (const member of groupData.members) {
                        await remove(ref(db, `userGroups/${member}/${groupId}`));
                    }
                    await remove(ref(db, `groups/${groupId}`));
                    await remove(ref(db, `groupMessages/${groupId}`));
                    alert("Grupa została usunięta.");
                    chatTitle.textContent = "Wybierz znajomego";
                    chatSub.textContent = "Prywatna rozmowa";
                    chatAvatar.innerHTML = "?";
                    messagesEl.innerHTML = "";
                    deleteGroupBtn.style.display = 'none';
                    membersPanel.style.display = 'none';
                    profileModal.style.display = 'none';
                    currentChatId = null;
                }
            }
        }

        deleteGroupBtn.onclick = () => {
            if (currentChatType === 'group' && currentChatId) {
                deleteGroup(currentChatId);
            }
        };

        function startListeners() {
            onValue(ref(db, `friends/${currentUser}`), () => loadFriends());
            onValue(ref(db, `friendRequests/${currentUser}`), () => loadRequests());
            onValue(ref(db, `userGroups/${currentUser}`), () => loadGroups());
            
            onValue(ref(db, 'groups'), (snapshot) => {
                if (snapshot.exists()) {
                    const groupsData = snapshot.val();
                    for (const groupId in groupsData) {
                        const group = groupsData[groupId];
                        const groupItem = document.querySelector(`.group-item[data-id="${groupId}"] .name`);
                        if (groupItem && groupItem.textContent !== group.name) {
                            groupItem.textContent = group.name;
                        }
                    }
                }
            });

            onValue(ref(db, 'status'), (snapshot) => {
                if (snapshot.exists()) {
                    const statuses = snapshot.val();
                    updateMemberStatuses(statuses);
                }
            });
        }

        function updateMemberStatuses(statuses) {
            const memberItems = membersList.querySelectorAll('.member-item');
            memberItems.forEach(item => {
                const nick = item.querySelector('.name').textContent;
                const statusInfo = statuses[nick] || 'Offline';
                const dot = item.querySelector('.avatar-status-dot');
                const statusTextEl = item.querySelector('.member-status-text');

                let color = 'gray';
                let statusText = statusInfo;
                let badge = '';

                switch (statusInfo) {
                    case 'Online':
                        color = 'green';
                        break;
                    case 'Zaraz wracam':
                        color = 'yellow';
                        break;
                    case 'Nie przeszkadzać':
                        color = 'red';
                        break;
                    case 'W grze':
                         color = '#5c6bc0';
                         badge = `👾 W grze <span class="status-badge">Gra</span>`;
                         break;
                    case 'Rozmawia':
                         color = '#2196F3';
                         badge = `🎤 Rozmawia <span class="status-badge">Rozmowa</span>`;
                         break;
                    default:
                        color = 'gray';
                }

                if (dot) dot.style.backgroundColor = color;
                if (statusTextEl) {
                    statusTextEl.innerHTML = badge || statusText;
                }
            });
        }

        async function loadFriends() {
            const snap = await get(ref(db, `friends/${currentUser}`));
            friendsListEl.innerHTML = '';
            if (snap.exists()) {
                snap.forEach(s => {
                    const nick = s.key;
                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    const avatarHtml = `<div>${nick.slice(0, 2).toUpperCase()}</div>`;
                    item.innerHTML = `
                        <div class="avatar">${avatarHtml}</div>
                        <div>
                            <div class="name">${nick}</div>
                            <div class="small-muted" id="st_${nick}">?</div>
                        </div>
                        <div class="right-actions">
                            <button class="dm-btn">DM</button>
                            <button class="delete-btn">Usuń</button>
                        </div>
                    `;
                    item.querySelector('.dm-btn').onclick = () => openChat(nick, 'dm');
                    item.querySelector('.delete-btn').onclick = () => deleteFriend(nick);
                    item.onclick = (e) => {
                        if (!e.target.closest('.right-actions')) {
                            showProfile(nick);
                        }
                    };
                    friendsListEl.appendChild(item);

                    const onRef = ref(db, 'status/' + nick);
                    onValue(onRef, snap => {
                        const stEl = document.getElementById('st_' + nick);
                        if (stEl) stEl.textContent = snap.exists() ? snap.val() : 'Offline';
                    });
                });
            }
        }

        async function loadGroups() {
            const snap = await get(ref(db, `userGroups/${currentUser}`));
            groupsListEl.innerHTML = '';
            if (snap.exists()) {
                const groupIds = Object.keys(snap.val());
                const promises = groupIds.map(groupId => get(ref(db, `groups/${groupId}`)));
                const groupDataSnaps = await Promise.all(promises);

                groupDataSnaps.forEach(groupDataSnap => {
                    if (groupDataSnap.exists()) {
                        const groupId = groupDataSnap.key;
                        const groupData = groupDataSnap.val();
                        const item = document.createElement('div');
                        item.className = 'group-item';
                        item.setAttribute('data-id', groupId);
                        item.innerHTML = `
                            <div class="avatar">#</div>
                            <div>
                                <div class="name">${groupData.name}</div>
                                <div class="small-muted">${groupData.members.length} członków</div>
                            </div>
                        `;
                        item.onclick = () => openChat(groupId, 'group');
                        groupsListEl.appendChild(item);
                    }
                });
            }
        }

        requestsToggle.onclick = () => {
            requestsListEl.style.display = requestsListEl.style.display === 'flex' ? 'none' : 'flex';
        };

        // ===== AUTO OFFLINE ON EXIT =====
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                set(ref(db, 'status/' + currentUser), 'Offline');
                remove(ref(db, 'online/' + currentUser));
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                if (document.visibilityState === 'hidden') {
                    set(ref(db, 'status/' + currentUser), 'Offline');
                    remove(ref(db, 'online/' + currentUser));
                } else {
                    set(ref(db, 'status/' + currentUser), 'Online');
                    set(ref(db, 'online/' + currentUser), true);
                }
            }
        });

        async function loadRequests() {
            const snap = await get(ref(db, `friendRequests/${currentUser}`));
            requestsListEl.innerHTML = '';
            const requests = snap.exists() ? snap.val() : {};
            const count = Object.keys(requests).length;
            requestsCountEl.textContent = count;

            if (count > 0) {
                Object.keys(requests).forEach(senderNick => {
                    const el = document.createElement('div');
                    el.className = 'request-item';
                    el.innerHTML = `<span class="name">${senderNick}</span>`;
                    const right = document.createElement('div');
                    right.className = 'right-actions';
                    const acc = document.createElement('button'); acc.textContent = 'Akceptuj'; acc.className = 'accept';
                    acc.onclick = async () => {
                        await set(ref(db, `friends/${currentUser}/${senderNick}`), true);
                        await set(ref(db, `friends/${senderNick}/${currentUser}`), true);
                        await remove(ref(db, `friendRequests/${currentUser}/${senderNick}`));
                    };
                    const rej = document.createElement('button'); rej.textContent = 'Odrzuć'; rej.className = 'delete-btn';
                    rej.onclick = async () => {
                        await remove(ref(db, `friendRequests/${currentUser}/${senderNick}`));
                    };
                    right.appendChild(acc);
                    right.appendChild(rej);
                    el.appendChild(right);
                    requestsListEl.appendChild(el);
                });
            } else {
                requestsListEl.innerHTML = '<div style="color: var(--muted); text-align:center;">Brak nowych zaproszeń.</div>';
            }
        }

        // ===== PROFILE MODAL =====
        async function showProfile(userNick) {
            const userRef = ref(db, `users/${userNick}`);
            const statusRef = ref(db, `status/${userNick}`);
            
            const userSnap = await get(userRef);
            const statusSnap = await get(statusRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.val();
                const status = statusSnap.val() || 'Offline';
                
                profileAvatar.innerHTML = `<div>${userNick.slice(0, 2).toUpperCase()}</div>`;
                profileNick.textContent = userNick;
                profileStatus.textContent = status;
                
                const joinDate = new Date(userData.createdAt).toLocaleDateString();
                profileJoinDate.textContent = `Dołączył: ${joinDate}`;
            }
            profileModal.style.display = 'flex';
        }

        document.addEventListener('click', (e) => {
            if (profileModal.style.display === 'flex' && !profileModal.contains(e.target) && !e.target.closest('.friend-item') && !e.target.closest('.member-item') && !e.target.closest('.profile')) {
                profileModal.style.display = 'none';
            }
        });

        // ===== CHAT =====
        async function openChat(id, type) {
            if (unsubscribeMessageListener) {
                unsubscribeMessageListener();
            }
            if (unsubscribeGroupMembersListener) {
                unsubscribeGroupMembersListener();
            }

            currentChatId = id;
            currentChatType = type;
            deleteGroupBtn.style.display = 'none';
            profileModal.style.display = 'none';
            membersPanel.style.display = 'none';
            contextMenu.style.display = 'none';
            messagesEl.innerHTML = '<div style="color: var(--muted); text-align:center; padding-top: 20px;">Ładowanie wiadomości...</div>';

            if (type === 'dm') {
                chatTitle.textContent = id;
                chatSub.textContent = 'Prywatna rozmowa';
                const avatarHtml = `<div>${id.slice(0, 2).toUpperCase()}</div>`;
                chatAvatar.innerHTML = avatarHtml;
                chatTitle.style.cursor = 'default';
            } else {
                const groupRef = ref(db, `groups/${id}`);
                const groupDataSnap = await get(groupRef);
                if (groupDataSnap.exists()) {
                    const groupData = groupDataSnap.val();
                    chatTitle.textContent = groupData.name;
                    chatSub.textContent = `${groupData.members.length} członków`;
                    chatAvatar.innerHTML = `<div>#</div>`;
                    if (groupData.owner === currentUser) {
                        deleteGroupBtn.style.display = 'block';
                    }
                    membersPanel.style.display = 'flex';
                    loadMembersPanel(groupData.members, groupData.owner);
                }
                chatTitle.style.cursor = 'pointer';
            }
            loadMessages();
        }

        function loadMembersPanel(members, owner) {
            membersList.innerHTML = '';
            for (const member of members) {
                const item = document.createElement('div');
                item.className = 'member-item';
                const isOwner = member === owner;
                const avatar = `
                    <div class="avatar">
                        <div>${member.slice(0, 2).toUpperCase()}</div>
                        <span class="avatar-status-dot" style="background:gray"></span>
                    </div>
                `;
                const nameAndStatus = `
                    <div class="member-info">
                        <div class="name-container">
                            <span class="name">${member}</span>
                            ${isOwner ? '<span class="owner-badge">👑</span>' : ''}
                        </div>
                        <div class="member-status">
                            <span class="member-status-text">Offline</span>
                        </div>
                    </div>
                `;
                item.innerHTML = avatar + nameAndStatus;
                item.onclick = () => showProfile(member);
                membersList.appendChild(item);
            }
            
            if (unsubscribeGroupMembersListener) {
                unsubscribeGroupMembersListener();
            }

            const statusRef = ref(db, 'status');
            unsubscribeGroupMembersListener = onValue(statusRef, (snapshot) => {
                const allStatuses = snapshot.val() || {};
                const statusesToUpdate = {};
                members.forEach(member => {
                    statusesToUpdate[member] = allStatuses[member] || 'Offline';
                });
                updateMemberStatuses(statusesToUpdate);
            });
        }

        chatTitle.addEventListener('dblclick', async () => {
            if (currentChatType === 'group' && currentChatId) {
                const currentName = chatTitle.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'chat-title-input';
                input.value = currentName;
                input.style.width = `${currentName.length * 1.2}ch`;

                chatTitle.replaceWith(input);
                input.focus();

                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        const newName = input.value.trim();
                        if (newName.length < 3) {
                            alert('Nazwa grupy musi mieć co najmniej 3 znaki.');
                            input.replaceWith(chatTitle);
                            chatTitle.textContent = currentName;
                            return;
                        }

                        const groupRef = ref(db, `groups/${currentChatId}`);
                        await update(groupRef, { name: newName });
                        
                        input.replaceWith(chatTitle);
                        chatTitle.textContent = newName;
                    }
                });

                input.addEventListener('blur', () => {
                    input.replaceWith(chatTitle);
                    chatTitle.textContent = currentName;
                });
            }
        });

        function loadMessages() {
            if (!currentChatId) return;
            const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
            const chatRef = ref(db, messagesPath);

            unsubscribeMessageListener = onValue(chatRef, snap => {
                messagesEl.innerHTML = '';
                if (snap.exists()) {
                    const messages = snap.val();
                    const messageKeys = Object.keys(messages);

                    messageKeys.forEach(msgId => {
                        const msg = messages[msgId];
                        const isMe = msg.from === currentUser;
                        
                        if (msg.isSystem) {
                            const systemMsgEl = document.createElement('div');
                            systemMsgEl.className = 'system-message';
                            systemMsgEl.textContent = msg.text;
                            messagesEl.appendChild(systemMsgEl);
                            return;
                        }

                        const container = document.createElement('div');
                        container.className = `msg-container ${isMe ? 'me' : ''}`;
                        const av = document.createElement('div');
                        av.className = 'avatar';
                        av.innerHTML = `<div>${msg.from.slice(0, 2).toUpperCase()}</div>`;
                        const div = document.createElement('div');
                        div.className = 'msg' + (isMe ? ' me' : '');
                        div.setAttribute('data-id', msgId);

                        let content;
                        if (msg.status === 'deleted') {
                            content = `<span class="deleted-msg">Cofnięto wysyłanie wiadomości</span>`;
                        } else {
                            const date = new Date(msg.timestamp);
                            const timeString = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                            content = `<div class="msg-info"><span>${msg.from}</span> <span class="timestamp">${timeString}</span></div>`;
                            if (msg.isImage) {
                                content += `<img src="${msg.text}" alt="Image" onclick="window.open(this.src)" />`;
                            } else if (msg.isGif) {
                                content += `<img src="${msg.text}" alt="GIF" onclick="window.open(this.src)" />`;}
                            else {
                                content += msg.text || '';
                            }
                        }

                        div.innerHTML = content;
                        container.appendChild(av);
                        container.appendChild(div);
                        messagesEl.appendChild(container);

                        if (isMe && msg.status !== 'deleted') {
                            div.addEventListener('contextmenu', e => {
                                e.preventDefault();
                                showContextMenu(e, msgId);
                            });
                        }
                    });
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                } else {
                    messagesEl.innerHTML = '<div style="color: var(--muted); text-align:center;">Rozpocznij konwersację.</div>';
                }
            }, (error) => {
                console.error("Firebase Read Error:", error);
                messagesEl.innerHTML = '<div>Błąd ładowania wiadomości. Sprawdź uprawnienia.</div>';
                if (error.code === 'PERMISSION_DENIED') {
                    console.log("Permission denied for path:", messagesPath);
                }
            });
        }

        function showContextMenu(e, msgId) {
            contextMenu.style.display = 'block';
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            activeMessageId = msgId;
        }

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && e.target.className !== 'msg') {
                contextMenu.style.display = 'none';
            }
        });

        deleteMsgItem.onclick = async () => {
            if (activeMessageId) {
                const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
                const messageRef = ref(db, `${messagesPath}/${activeMessageId}`);
                try {
                    await update(messageRef, { text: null, status: 'deleted', isImage: false, isGif: false });
                } catch (error) {
                    alert("Wystąpił błąd podczas usuwania wiadomości. Sprawdź uprawnienia.");
                    console.error("Error deleting message:", error);
                }
                contextMenu.style.display = 'none';
            }
        };

        sendMsgBtn.onclick = async () => {
            const text = msgInput.value.trim();
            if (!text || !currentChatId) return;

            const isImage = /\.(jpg|jpeg|png|webp|avif|gif)$/i.test(text);
            const isGif = /\.(gif)$/i.test(text);

            const message = {
                from: currentUser,
                text: text,
                timestamp: Date.now(),
                isImage: isImage,
                isGif: isGif
            };

            const messagesPath = currentChatType === 'dm' ? 'dms/' + [currentUser, currentChatId].sort().join('_') : 'groupMessages/' + currentChatId;
            try {
                await push(ref(db, messagesPath), message);
                msgInput.value = '';
            } catch (error) {
                alert("Błąd wysyłania wiadomości. Sprawdź połączenie lub uprawnienia.");
                console.error("Error sending message:", error);
            }
        };

        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMsgBtn.click();
            }
        });

        const loggedInUser = localStorage.getItem('currentUser');
        if (loggedInUser) {
            loginAs(loggedInUser);
        } else {
            authModal.style.display = 'flex';
        }

        /* ======= MOJE DODATKI JS (RESPONSYWNE ZACHOWANIE NA MOBILE) ======= */

        // referencje do elementów (nie nadpisują istniejącej logiki)
        const sidebar = document.querySelector('.sidebar');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop') || document.querySelector('.sidebar-backdrop');

        // przyciski mobilne (istnieją w HTML dodane powyżej)
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const toggleMembersBtn = document.getElementById('toggleMembers');

        // funkcja wykrywająca mobile (oparta o szerokość) i ustawiająca klasę
        function updateDeviceClass() {
            if (window.matchMedia('(max-width: 768px)').matches) {
                document.body.classList.add('is-mobile');
                // zamknij panele przy wejściu w mobile, żeby nie zostały otwarte
                sidebar && sidebar.classList.remove('active');
                membersPanel && membersPanel.classList.remove('active');
                sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
            } else {
                document.body.classList.remove('is-mobile');
                // upewnij się, że backdrop i panele są zamknięte na desktopie
                sidebar && sidebar.classList.remove('active');
                membersPanel && membersPanel.classList.remove('active');
                sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
            }
        }
        updateDeviceClass();
        window.addEventListener('resize', updateDeviceClass);

        // toggle sidebar (hamburger)
        if (toggleSidebarBtn) {
            toggleSidebarBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!sidebar) return;
                const willOpen = !sidebar.classList.contains('active');
                if (willOpen) {
                    sidebar.classList.add('active');
                    sidebarBackdrop && sidebarBackdrop.classList.add('visible');
                } else {
                    sidebar.classList.remove('active');
                    sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
                }
            });
        }

        // toggle members panel
        if (toggleMembersBtn) {
            toggleMembersBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const willOpen = !membersPanel.classList.contains('active');
                if (willOpen) {
                    membersPanel.classList.add('active');
                    sidebarBackdrop && sidebarBackdrop.classList.add('visible');
                } else {
                    membersPanel.classList.remove('active');
                    sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
                }
            });
        }

        // kliknięcie w backdrop zamyka panele
        if (sidebarBackdrop) {
            sidebarBackdrop.addEventListener('click', () => {
                sidebar && sidebar.classList.remove('active');
                membersPanel && membersPanel.classList.remove('active');
                sidebarBackdrop.classList.remove('visible');
            });
        }

        // gdy klikniesz znajomego lub grupę na mobile, ukryj sidebar (żeby widać chat)
        document.addEventListener('click', (e) => {
            if (window.matchMedia('(max-width: 768px)').matches) {
                const friendEl = e.target.closest('.friend-item');
                const groupEl = e.target.closest('.group-item');

                if (friendEl || groupEl) {
                    // jeśli kliknięcie było w prawy obszar akcji (np. delete) to nie zamykamy
                    if (e.target.closest('.right-actions')) return;

                    sidebar && sidebar.classList.remove('active');
                    sidebarBackdrop && sidebarBackdrop.classList.remove('visible');
                }
            }
        });


    </script>
    
</body>
</html>
